<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SFProDisplay-Regular.otf') format('otf');
      font-weight: 400;
      font-style: normal;
    }
    body {
      font-family: 'SF Pro Display';
      background: linear-gradient(135deg, #181c2f 0%, #2a225a 50%, #3a1c71 100%);
      color: #e6e6f0;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .main-wrapper {
      max-width: 1300px;
      margin: 0 auto;
      padding: 32px 32px 32px 32px;
    }
    h1, h3, h4 {
      font-weight: 700;
      color: #e0d7ff;
      margin-bottom: 10px;
      letter-spacing: 0.01em;
    }
    h1 {
      font-size: 2.2rem;
      margin-top: 30px;
    }
    .section-card {
      background: rgba(28, 24, 48, 0.98);
      border-radius: 22px;
      box-shadow: 0 6px 32px rgba(60, 80, 180, 0.18), 0 2px 8px rgba(60, 80, 180, 0.10);
      padding: 36px 36px 28px 36px;
      margin: 40px auto 0 auto;
      max-width: 1200px;
      width: 100%;
      border: 1.5px solid #2a225a;
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 18px;
      background: #23203a;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(60, 80, 180, 0.10);
    }
    th, td {
      padding: 16px 14px;
      border-bottom: 1px solid #2a225a;
      text-align: left;
    }
    th {
      background: #2a225a;
      color: #b7aaff;
      font-weight: 600;
      font-size: 1.05rem;
      letter-spacing: 0.01em;
    }
    tr:last-child td {
      border-bottom: none;
    }
    input, select, textarea {
      padding: 12px 14px;
      border: 1.5px solid #3a2d6a;
      border-radius: 9px;
      font-size: 1rem;
      margin: 8px 0 16px 0;
      background: #23203a;
      color: #e6e6f0;
      transition: border 0.2s, background 0.2s;
      outline: none;
    }
    input:focus, select:focus, textarea:focus {
      border: 1.5px solid #a084ff;
      background: #2a225a;
    }
    button {
      padding: 12px 28px;
      border: none;
      border-radius: 9px;
      font-size: 1.08rem;
      font-weight: 600;
      cursor: pointer;
      margin: 8px 8px 8px 0;
      transition: background 0.2s, color 0.2s, box-shadow 0.2s, transform 0.1s;
      box-shadow: 0 2px 16px rgba(80, 60, 180, 0.18);
      letter-spacing: 0.01em;
      outline: none;
      border: 1.5px solid transparent;
    }
    .btn-success {
      background: linear-gradient(90deg, #43e97b 0%, #38f9d7 100%);
      color: #fff;
      border: 1.5px solid #38f9d7;
      text-shadow: 0 1px 8px #1b2b3a44;
      box-shadow: 0 2px 16px #38f9d755;
    }
    .btn-danger {
      background: linear-gradient(90deg, #ff5858 0%, #a83279 100%);
      color: #fff;
      border: 1.5px solid #a83279;
      text-shadow: 0 1px 8px #1b2b3a44;
      box-shadow: 0 2px 16px #a8327955;
    }
    .btn, .btn-main, .btn-logout {
      background: linear-gradient(90deg, #3a1c71 0%, #2a225a 100%);
      color: #fff;
      border: 1.5px solid #a084ff;
      font-size: 1.12rem;
      font-weight: 700;
      box-shadow: 0 4px 24px #3a1c7144, 0 1.5px 4px #2a225a33;
      text-shadow: 0 1px 8px #1b2b3a44;
    }
    .btn-logout {
      background: linear-gradient(90deg, #a83279 0%, #3a1c71 100%);
      border: 1.5px solid #a83279;
      color: #fff;
      font-size: 1.12rem;
      font-weight: 700;
      margin-bottom: 18px;
      margin-top: 8px;
      float: right;
      box-shadow: 0 4px 24px #a8327944, 0 1.5px 4px #3a1c7133;
    }
    .btn-details {
      background: linear-gradient(90deg, #4e54c8 0%, #8f94fb 100%);
      color: #fff;
      border: 1.5px solid #6c70d6;
      font-size: 1.08rem;
      font-weight: 700;
      text-shadow: none;
      box-shadow: 0 1.5px 6px #23203a55;
      transition: background 0.18s, border 0.18s, box-shadow 0.18s, transform 0.1s;
    }
    .btn-details:hover {
      background: linear-gradient(90deg, #6c70d6 0%, #a5aae7 100%);
      border-color: #a5aae7;
      box-shadow: 0 4px 16px #23203a77;
      filter: none;
      transform: translateY(-1px) scale(1.02);
    }
    .btn-danger {
      background: linear-gradient(90deg, #c94b4b 0%, #4b134f 100%);
      color: #fff;
      border: 1.5px solid #a13a3a;
      text-shadow: none;
      box-shadow: 0 1.5px 6px #23203a55;
      transition: background 0.18s, border 0.18s, box-shadow 0.18s, transform 0.1s;
    }
    .btn-danger:hover {
      background: linear-gradient(90deg, #a13a3a 0%, #6d2b5b 100%);
      border-color: #a13a3a;
      box-shadow: 0 4px 16px #23203a77;
      filter: none;
      transform: translateY(-1px) scale(1.02);
    }
    .btn:hover, .btn-success:hover, .btn-main:hover, .btn-logout:hover, .btn-details:hover {
      filter: brightness(1);
      box-shadow: 0 8px 32px #a084ff55, 0 2px 8px #3a1c7133;
      transform: translateY(-2px) scale(1.02);
      border-color: #fff;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(28, 24, 48, 0.88);
      backdrop-filter: blur(20px);
    }
    .modal-content {
      background: #23203a;
      margin: 3% auto;
      padding: 40px 32px 32px 32px;
      border-radius: 22px !important;
      box-shadow: 0 8px 32px #3a1c7144;
      max-width: 440px;
      width: 97%;
      color: #e6e6f0;
    }
    .modal-input {
      width: 100%;
      margin: 10px 0 20px 0;
      padding: 14px;
      border: 1.5px solid #3a2d6a;
      border-radius: 9px;
      font-size: 1rem;
      background: #181c2f;
      color: #e6e6f0;
    }
    .btn-right {
      text-align: right;
      margin-top: 20px;
    }
    hr {
      border: none;
      border-top: 2px solid #2a225a;
      margin: 40px 0 28px 0;
    }
    .stat-block {
      background: #23203a;
      border-radius: 12px;
      padding: 22px 28px;
      margin: 22px 0;
      color: #b7aaff;
      font-size: 1.13rem;
      box-shadow: 0 2px 8px #3a1c7144;
    }
    .stat-title {
      font-weight: 700;
      color: #a084ff;
      margin-bottom: 10px;
    }
    .stat-detail {
      margin-left: 22px;
      color: #e6e6f0;
      font-size: 1.01rem;
    }
    .stat-brand {
      margin-top: 16px;
      font-weight: 500;
      color: #e0d7ff;
    }
    .stat-screen {
      margin-left: 28px;
      color: #a084ff;
      font-size: 1.01rem;
    }
    .stat-campaign {
      margin-left: 40px;
      color: #e6e6f0;
      font-size: 0.99rem;
    }
    .stat-btn {
      float: right;
      margin-top: -8px;
    }
    .checkbox, .radio {
      accent-color: #a084ff;
      width: 20px;
      height: 20px;
      margin-right: 10px;
      background: #23203a;
      border-radius: 4px;
      border: 1.5px solid #3a2d6a;
    }
    @media (max-width: 1100px) {
      .main-wrapper, .section-card {
        max-width: 98vw;
        padding: 12px 2vw 12px 2vw;
      }
      .modal-content {
        padding: 18px 2vw 12px 2vw;
      }
      table th, table td {
        padding: 8px 4px;
      }
    }
    @media (max-width: 700px) {
      .main-wrapper, .section-card {
        padding: 6px 1vw 6px 1vw;
        margin: 18px auto 0 auto;
      }
      h1 {
        font-size: 1.3rem;
      }
      .modal-content {
        padding: 8px 1vw 8px 1vw;
      }
      table th, table td {
        padding: 5px 2px;
        font-size: 0.92rem;
      }
      button, .btn, .btn-main, .btn-logout, .btn-details {
        padding: 10px 10px;
        font-size: 0.98rem;
      }
      input, select, textarea, .modal-input {
        font-size: 0.95rem;
        padding: 8px 8px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // Fallback QR code generation if library fails to load
    window.generateSimpleQR = function(text, elementId) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      // Create a simple text representation
      element.innerHTML = `
        <div style="border: 2px solid #333; padding: 20px; display: inline-block; background: white;">
          <div style="font-family: monospace; font-size: 10px; line-height: 1;">
            ${text.split('').map(char => char === ' ' ? '&nbsp;' : char).join('')}
          </div>
        </div>
        <p style="margin-top: 10px; color: #666; font-size: 12px;">
          QR Code Data: ${text.substring(0, 50)}...
        </p>
      `;
    };
  </script>
  <script>
  const token = localStorage.getItem('token');
  const isAdmin = localStorage.getItem('isAdmin');
  if (!token || isAdmin !== 'true') {
    alert('üö´ –î–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞!');
    location.href = '/admin-login.html';
  }
  </script>
</head>
<body>
<div class="main-wrapper">

<button onclick="logout()" class="btn-logout">–í—ã–π—Ç–∏</button>
<script>
  function logout() {
    localStorage.clear();
    window.location.replace('/admin-login.html');
  }
</script>
  
<!-- ===== BRANDS SECTION ===== -->
<h1>–ë—Ä–µ–Ω–¥—ã</h1>
<div>
  <input type="text" id="brandName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞">
  <input type="email" id="brandEmail" placeholder="Email">
  <input type="password" id="brandPassword" placeholder="–ü–∞—Ä–æ–ª—å">
  <button onclick="createBrand()" class="btn-main">–°–æ–∑–¥–∞—Ç—å –±—Ä–µ–Ω–¥</button>
</div>

<table id="brandsTable">
  <thead>
    <tr>
      <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
      <th>Email</th>
      <th>ID</th>
      <th>–ü–∞—Ä–æ–ª—å</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Brand Edit Modal -->
<div id="editBrandModal" class="modal" onclick="closeEditModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="margin-top: 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –±—Ä–µ–Ω–¥</h3>
    <input type="hidden" id="editBrandId">
    <input type="text" id="editBrandName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞" class="modal-input"><br>
    <input type="email" id="editBrandEmail" placeholder="Email" class="modal-input"><br>
    <input type="password" id="editBrandPassword" placeholder="–ü–∞—Ä–æ–ª—å" class="modal-input"><br>
    <div class="btn-right">
      <button onclick="saveBrandEdit()" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeEditModal()" class="btn btn-danger">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<hr>

<!-- ===== SCREENS SECTION ===== -->
<h1>–≠–∫—Ä–∞–Ω—ã</h1>
<div>
  <input type="text" id="screenId" placeholder="ID —ç–∫—Ä–∞–Ω–∞">
  <input type="text" id="screenBrandId" placeholder="ID –±—Ä–µ–Ω–¥–∞">
  <button onclick="createScreen()" class="btn-main">–°–æ–∑–¥–∞—Ç—å —ç–∫—Ä–∞–Ω</button>
</div>

<table id="screensTable">
  <thead>
    <tr>
      <th>ID —ç–∫—Ä–∞–Ω–∞</th>
      <th>–ë—Ä–µ–Ω–¥</th>
      <th>–ö–∞–º–ø–∞–Ω–∏—è</th>
      <th>–î–µ–π—Å—Ç–≤–∏—è</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Screen Edit Modal -->
<div id="editScreenModal" class="modal" onclick="closeScreenEditModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="margin-top: 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–∫—Ä–∞–Ω</h3>
    <input type="hidden" id="editScreenId">
    <input type="text" id="editScreenScreenId" placeholder="ID —ç–∫—Ä–∞–Ω–∞" class="modal-input"><br>
    <input type="text" id="editScreenBrandId" placeholder="ID –±—Ä–µ–Ω–¥–∞" class="modal-input"><br>
    <div class="btn-right">
      <button onclick="saveScreenEdit()" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeScreenEditModal()" class="btn btn-danger">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<hr>

<!-- ===== CAMPAIGNS SECTION ===== -->
<h1>–°–æ–∑–¥–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏</h1>
<div>
  <input type="text" id="campaignName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏"><br><br>

  <label>–ë—Ä–µ–Ω–¥:</label>
  <select id="campaignBrandSelect"></select><br><br>

  <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
  <input type="date" id="campaignStart">
  <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
  <input type="date" id="campaignEnd"><br><br>

  <textarea id="campaignVideos" rows="4" cols="60" placeholder="–û–¥–Ω–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ –≤ —Å—Ç—Ä–æ–∫–µ..."></textarea><br><br>

  <label>–ü—Ä–æ–º–æ URL:</label>
  <input type="url" id="campaignPromoUrl" placeholder="https://example.com/promo" style="width: 300px;"><br><br>

  <button onclick="createCampaign()" class="btn-main">–°–æ–∑–¥–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</button>
</div>

<hr>
<h1>–°–ø–∏—Å–æ–∫ –∫–∞–º–ø–∞–Ω–∏–π</h1>
<div id="campaignList"></div>

<!-- Campaign Edit Modal -->
<div id="editCampaignModal" class="modal" onclick="closeCampaignEditModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="margin-top: 0;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–∞–º–ø–∞–Ω–∏—é</h3>
    <input type="hidden" id="editCampaignId">
    <input type="text" id="editCampaignName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏" class="modal-input"><br>
    <label>–î–∞—Ç–∞ –Ω–∞—á–∞–ª–∞:</label>
    <input type="date" id="editCampaignStart" class="modal-input"><br>
    <label>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è:</label>
    <input type="date" id="editCampaignEnd" class="modal-input"><br>
    <label>–ü—Ä–æ–º–æ URL:</label>
    <input type="url" id="editCampaignPromoUrl" placeholder="https://example.com/promo" class="modal-input"><br>
    <label>–°—Å—ã–ª–∫–∏ –Ω–∞ –≤–∏–¥–µ–æ:</label><br>
    <textarea id="editCampaignVideos" rows="4" class="modal-input"></textarea><br>
    <div class="btn-right">
      <button onclick="saveCampaignEdit()" class="btn btn-success">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button onclick="closeCampaignEditModal()" class="btn btn-danger">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<hr>

<!-- ===== CAMPAIGN ASSIGNMENT SECTION ===== -->
<h1>–ü—Ä–∏–≤—è–∑–∫–∞ –∫–∞–º–ø–∞–Ω–∏–∏ –∫ —ç–∫—Ä–∞–Ω—É</h1>
<div>
  <label>–≠–∫—Ä–∞–Ω:</label>
  <select id="selectScreen"></select>

  <label>–ö–∞–º–ø–∞–Ω–∏—è:</label>
  <select id="selectCampaign"></select>

  <button onclick="assignCampaign()" class="btn-main">–ù–∞–∑–Ω–∞—á–∏—Ç—å</button>
</div>

<h2>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h2>
<div style="display: flex; gap: 10px; margin-bottom: 15px;">
  <button onclick="loadStats()" class="btn btn-success">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
  <button onclick="showClearStatsModal()" class="btn btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</button>
</div>
<div id="statsSummary"></div>

<!-- Clear Statistics Modal -->
<div id="clearStatsModal" class="modal">
  <div class="modal-content" style="width: 500px; max-width: 90%;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
      <h3 style="margin: 0; color: #333;">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</h3>
      <button onclick="closeClearStatsModal()" class="btn btn-danger" style="margin: 0;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 10px; font-weight: bold;">–í—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ –æ—á–∏—Å—Ç–∏—Ç—å:</label>
      
      <div style="margin-bottom: 15px;">
        <input type="radio" id="clearAll" name="clearType" value="all" checked>
        <label for="clearAll">–í—Å—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</label>
      </div>
      
      <div style="margin-bottom: 15px;">
        <input type="radio" id="clearBrand" name="clearType" value="brand">
        <label for="clearBrand">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –±—Ä–µ–Ω–¥–∞</label>
        <select id="clearBrandSelect" style="margin-left: 10px; padding: 5px; display: none;">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥...</option>
        </select>
      </div>
      
      <div style="margin-bottom: 15px;">
        <input type="radio" id="clearCampaign" name="clearType" value="campaign">
        <label for="clearCampaign">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∫–∞–º–ø–∞–Ω–∏–∏</label>
        <select id="clearCampaignSelect" style="margin-left: 10px; padding: 5px; display: none;">
          <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é...</option>
        </select>
      </div>
    </div>
    
    <div style="text-align: center;">
      <button onclick="clearStats()" class="btn btn-danger">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
      <button onclick="closeClearStatsModal()" class="btn" style="margin-left: 10px;">–û—Ç–º–µ–Ω–∞</button>
    </div>
  </div>
</div>

<!-- Brand Details Chart Modal -->
<div id="brandChartModal" class="modal" onclick="closeBrandChartModal()">
  <div class="modal-content" style="width: 95%; max-width: 1200px; margin: 2% auto; border-radius: 15px !important; overflow: hidden;" onclick="event.stopPropagation()">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
      <h2 style="margin: 0; color: #c9b5ff; font-size: 24px;">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: <span id="chartBrandName" style="color: #007bff;"></span></h2>
      <button onclick="closeBrandChartModal()" class="btn btn-danger" style="margin: 0;">‚úï –ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 30px; margin-bottom: 30px; min-height: 500px;">
      <!-- Chart Section -->
      <div style="background: #0f0e19; padding: 20px; border-radius: 10px; overflow: hidden;">
        <div style="margin-bottom: 20px;">
          <label style="font-weight: bold; margin-right: 10px; color: #c9b5ff;">üìÖ –ü–µ—Ä–∏–æ–¥:</label>
          <select id="chartPeriod" onchange="loadBrandChart()" style="padding: 8px 15px; border: 1px solid #c9b5ff; border-radius: 5px; background: #23203a;">
            <option value="7">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π</option>
            <option value="30">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</option>
            <option value="90">–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞</option>
            <option value="365">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≥–æ–¥</option>
          </select>
        </div>
        
        <div style="background: #0f0e19; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
          <canvas id="brandChart" width="400" height="400" style="max-width: 100%; height: auto;"></canvas>
        </div>
      </div>
      
      <!-- Stats Section -->
      <div id="brandChartDetails" style="background: #0f0e19; padding: 20px; border-radius: 10px; height: fit-content; overflow: hidden;"></div>
    </div>
  </div>
</div>

<script>
// API URL - always use production server since that's where the backend is running
const API = 'https://lunqo.app/api/admin';

// ===== UTILITY FUNCTIONS =====
function authorizedFetch(url, options = {}) {
  const token = localStorage.getItem('token');
  return fetch(url, {
    ...options,
    headers: {
      'Authorization': 'Bearer ' + token,
      ...(options.headers || {})
    }
  });
}

// ===== BRAND FUNCTIONS =====
async function loadBrands() {
  try {
  const res = await authorizedFetch(`${API}/brands`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
    
  const table = document.querySelector("#brandsTable tbody");
  table.innerHTML = "";
    
    const brands = Array.isArray(data) ? data : [];
    brands.forEach(brand => {
    table.innerHTML += `
      <tr>
          <td>${brand.name || 'N/A'}</td>
          <td>${brand.email || 'N/A'}</td>
          <td>${brand._id || 'N/A'}</td>
          <td>${brand.password || 'N/A'}</td>
          <td>
            <button onclick="editBrand('${brand._id}')" class="btn-details">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button onclick="deleteBrand('${brand._id}')" class="btn-danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
          </td>
      </tr>`;
  });
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±—Ä–µ–Ω–¥–æ–≤: ' + error.message);
  }
}

async function createBrand() {
  try {
  const name = document.getElementById('brandName').value;
  const email = document.getElementById('brandEmail').value;
    const password = document.getElementById('brandPassword').value;
    if (!name || !email || !password) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è, email –∏ –ø–∞—Ä–æ–ª—å');
    
    const res = await authorizedFetch(`${API}/brands`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password })
    });
    
    //if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || `HTTP error ${res.status}`);
    }
  alert('‚úÖ –ë—Ä–µ–Ω–¥ —Å–æ–∑–¥–∞–Ω');
    document.getElementById('brandName').value = '';
    document.getElementById('brandEmail').value = '';
    document.getElementById('brandPassword').value = '';
    loadBrands(); 
    populateBrandsForCampaign();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±—Ä–µ–Ω–¥–∞: ' + error.message);
  }
}

async function editBrand(id) {
  try {
    const res = await authorizedFetch(`${API}/brands/${id}`);
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    const brand = await res.json();
    document.getElementById('editBrandId').value = brand._id;
    document.getElementById('editBrandName').value = brand.name || '';
    document.getElementById('editBrandEmail').value = brand.email || '';
    document.getElementById('editBrandPassword').value = brand.password || '';
    document.getElementById('editBrandModal').style.display = 'block';
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –±—Ä–µ–Ω–¥–∞: ' + error.message);
  }
}

async function saveBrandEdit() {
  try {
    const id = document.getElementById('editBrandId').value;
    const name = document.getElementById('editBrandName').value;
    const email = document.getElementById('editBrandEmail').value;
    const password = document.getElementById('editBrandPassword').value;
    
    if (!name || !email || !password) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    
    const res = await authorizedFetch(`${API}/brands/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password })
    });
    
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    alert('‚úÖ –ë—Ä–µ–Ω–¥ –æ–±–Ω–æ–≤–ª–µ–Ω');
    closeEditModal();
    loadBrands();
    populateBrandsForCampaign();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + error.message);
  }
}

function closeEditModal() {
  document.getElementById('editBrandModal').style.display = 'none';
  document.getElementById('editBrandId').value = '';
  document.getElementById('editBrandName').value = '';
  document.getElementById('editBrandEmail').value = '';
  document.getElementById('editBrandPassword').value = '';
}

async function deleteBrand(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –±—Ä–µ–Ω–¥?')) return;
  try {
    const res = await authorizedFetch(`${API}/brands/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    
    loadBrands(); 
    populateBrandsForCampaign();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±—Ä–µ–Ω–¥–∞: ' + error.message);
  }
}

// ===== SCREEN FUNCTIONS =====
async function loadScreens() {
  try {
  const res = await authorizedFetch(`${API}/screens`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
    
  const table = document.querySelector("#screensTable tbody");
  table.innerHTML = "";
    
    const screens = Array.isArray(data) ? data : [];
    screens.forEach(screen => {
    table.innerHTML += `
      <tr>
          <td>${screen.screenId || 'N/A'}</td>
        <td>${screen.brandId || '-'}</td>
        <td>${screen.currentCampaignId || '-'}</td>
          <td>
            <button onclick="editScreen('${screen._id}')" class="btn-details">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
            <button onclick="deleteScreen('${screen._id}')" class="btn-danger">üóë –£–¥–∞–ª–∏—Ç—å</button>
          </td>
      </tr>`;
  });
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —ç–∫—Ä–∞–Ω–æ–≤: ' + error.message);
  }
}

async function createScreen() {
  try {
  const screenId = document.getElementById('screenId').value;
  const brandId = document.getElementById('screenBrandId').value;
  if (!screenId || !brandId) return alert('–í–≤–µ–¥–∏—Ç–µ –æ–±–∞ –∑–Ω–∞—á–µ–Ω–∏—è');
    
    const res = await authorizedFetch(`${API}/screens`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ screenId, brandId })
  });
    
    //if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || `HTTP error ${res.status}`);
    }
  alert('‚úÖ –≠–∫—Ä–∞–Ω —Å–æ–∑–¥–∞–Ω');
    document.getElementById('screenId').value = '';
    document.getElementById('screenBrandId').value = '';
    loadScreens(); 
    populateScreens();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —ç–∫—Ä–∞–Ω–∞: ' + error.message);
  }
}

async function editScreen(id) {
  try {
    const res = await authorizedFetch(`${API.replace('/admin', '')}/screens/${id}`);
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    const screen = await res.json();
    document.getElementById('editScreenId').value = screen._id;
    document.getElementById('editScreenScreenId').value = screen.screenId || '';
    document.getElementById('editScreenBrandId').value = screen.brandId || '';
    document.getElementById('editScreenModal').style.display = 'block';
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö —ç–∫—Ä–∞–Ω–∞: ' + error.message);
  }
}

async function saveScreenEdit() {
  try {
    const id = document.getElementById('editScreenId').value;
    const screenId = document.getElementById('editScreenScreenId').value;
    const brandId = document.getElementById('editScreenBrandId').value;
    if (!screenId || !brandId) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
    
    const res = await authorizedFetch(`${API}/screens/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ screenId, brandId })
    });
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    alert('‚úÖ –≠–∫—Ä–∞–Ω –æ–±–Ω–æ–≤–ª–µ–Ω');
    closeScreenEditModal();
    loadScreens();
    populateScreens();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + error.message);
  }
}

function closeScreenEditModal() {
  document.getElementById('editScreenModal').style.display = 'none';
  document.getElementById('editScreenId').value = '';
  document.getElementById('editScreenScreenId').value = '';
  document.getElementById('editScreenBrandId').value = '';
}

async function deleteScreen(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å —ç–∫—Ä–∞–Ω?')) return;
  try {
    const res = await authorizedFetch(`${API.replace('/admin', '')}/screens/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    alert('‚úÖ –≠–∫—Ä–∞–Ω —É–¥–∞–ª—ë–Ω');
    loadScreens();
    populateScreens();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —ç–∫—Ä–∞–Ω–∞: ' + error.message);
  }
}

// ===== CAMPAIGN FUNCTIONS =====
async function loadCampaignsList() {
  try {
    const res = await authorizedFetch(`${API}/campaigns`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
    
    const list = document.getElementById('campaignList');
    list.innerHTML = '';
    
    const campaigns = Array.isArray(data) ? data : [];
    campaigns.forEach(c => {
      const el = document.createElement('div');
      el.innerHTML = `<b>${c.name || 'N/A'}</b> (${c._id || 'N/A'}) <button onclick="editCampaign('${c._id}')" class="btn-details">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button> <button onclick="deleteCampaign('${c._id}')" class="btn-danger">üóë –£–¥–∞–ª–∏—Ç—å</button> <button onclick="generateQRCode('${c._id}')" class="btn-main">üì± QR –∫–æ–¥</button>`;
      list.appendChild(el);
    });
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–º–ø–∞–Ω–∏–π: ' + error.message);
  }
}

async function createCampaign() {
  try {
    const name = document.getElementById('campaignName').value;
    const brandId = document.getElementById('campaignBrandSelect').value;
    const startDate = document.getElementById('campaignStart').value;
    const endDate = document.getElementById('campaignEnd').value;
    const videoLinks = document.getElementById('campaignVideos').value.split('\n').map(v => v.trim()).filter(Boolean);
    const promoUrl = document.getElementById('campaignPromoUrl').value;
    if (!name || !brandId || videoLinks.length === 0) return alert('–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ, –±—Ä–µ–Ω–¥ –∏ –≤–∏–¥–µ–æ');
    const res = await authorizedFetch(`${API}/campaigns`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, brandId, startDate, endDate, videos: videoLinks, promoUrl })
    });
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    alert('‚úÖ –ö–∞–º–ø–∞–Ω–∏—è —Å–æ–∑–¥–∞–Ω–∞');
    document.getElementById('campaignName').value = '';
    document.getElementById('campaignBrandSelect').value = '';
    document.getElementById('campaignStart').value = '';
    document.getElementById('campaignEnd').value = '';
    document.getElementById('campaignVideos').value = '';
    document.getElementById('campaignPromoUrl').value = '';
    loadCampaignsList();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
  }
}

async function editCampaign(id) {
  try {
    const res = await authorizedFetch(`${API}/campaigns/${id}`);
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    const campaign = await res.json();
    document.getElementById('editCampaignId').value = campaign._id;
    document.getElementById('editCampaignName').value = campaign.name || '';
    document.getElementById('editCampaignStart').value = campaign.startDate ? campaign.startDate.substr(0,10) : '';
    document.getElementById('editCampaignEnd').value = campaign.endDate ? campaign.endDate.substr(0,10) : '';
    document.getElementById('editCampaignPromoUrl').value = campaign.promoUrl || '';
    document.getElementById('editCampaignVideos').value = Array.isArray(campaign.videos) ? campaign.videos.join('\n') : '';
    document.getElementById('editCampaignModal').style.display = 'block';
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
  }
}

async function saveCampaignEdit() {
  try {
    const id = document.getElementById('editCampaignId').value;
    const name = document.getElementById('editCampaignName').value;
    const startDate = document.getElementById('editCampaignStart').value;
    const endDate = document.getElementById('editCampaignEnd').value;
    const promoUrl = document.getElementById('editCampaignPromoUrl').value;
    const videos = document.getElementById('editCampaignVideos').value.split('\n').map(v => v.trim()).filter(Boolean);
    if (!name || videos.length === 0) return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ –≤–∏–¥–µ–æ');
    
    const res = await authorizedFetch(`${API}/campaigns/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, startDate, endDate, promoUrl, videos })
    });
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    alert('‚úÖ –ö–∞–º–ø–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
    closeCampaignEditModal();
    loadCampaignsList();
    populateCampaigns();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π: ' + error.message);
  }
}

function closeCampaignEditModal() {
  document.getElementById('editCampaignModal').style.display = 'none';
  document.getElementById('editCampaignId').value = '';
  document.getElementById('editCampaignName').value = '';
  document.getElementById('editCampaignStart').value = '';
  document.getElementById('editCampaignEnd').value = '';
  document.getElementById('editCampaignPromoUrl').value = '';
  document.getElementById('editCampaignVideos').value = '';
}

async function deleteCampaign(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–∞–º–ø–∞–Ω–∏—é?')) return;
  try {
    const res = await authorizedFetch(`${API}/campaigns/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    alert('‚úÖ –ö–∞–º–ø–∞–Ω–∏—è —É–¥–∞–ª–µ–Ω–∞');
    loadCampaignsList();
    populateCampaigns();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
  }
}

// ===== POPULATE FUNCTIONS =====
async function populateScreens() {
  try {
  const res = await authorizedFetch(`${API}/screens`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
  const select = document.getElementById('selectScreen');
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Ä–∞–Ω</option>';
    
    const screens = Array.isArray(data) ? data : [];
    screens.forEach(s => {
    const option = document.createElement('option');
    option.value = s.screenId;
    option.textContent = s.screenId;
    select.appendChild(option);
  });
  } catch (error) {
    console.error('Error populating screens:', error);
  }
}

async function populateCampaigns() {
  try {
  const res = await authorizedFetch(`${API}/campaigns`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
  const select = document.getElementById('selectCampaign');
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é</option>';
    
    const campaigns = Array.isArray(data) ? data : [];
    campaigns.forEach(c => {
    const option = document.createElement('option');
    option.value = c._id;
    option.textContent = c.name;
    select.appendChild(option);
  });
  } catch (error) {
    console.error('Error populating campaigns:', error);
  }
}

// ===== ASSIGNMENT FUNCTIONS =====
async function assignCampaign() {
  try {
  const screenId = document.getElementById('selectScreen').value;
  const campaignId = document.getElementById('selectCampaign').value;
  if (!screenId || !campaignId) return alert('–í—ã–±–µ—Ä–∏ –æ–±–∞ –ø–æ–ª—è');
    
    const res = await authorizedFetch(`${API.replace('/admin','')}/screens/assign-campaign`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ screenId, campaignId })
  });
    
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    
  alert('‚úÖ –ö–∞–º–ø–∞–Ω–∏—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∞');
  loadScreens();
  } catch (error) {
    alert('–û—à–∏–±–∫–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∫–∞–º–ø–∞–Ω–∏–∏: ' + error.message);
  }
}

// ===== STATS FUNCTIONS =====
async function loadStats() {
  const res = await authorizedFetch(`${API}/stats/summary`);
  if (!res.ok) return alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏');
  const data = await res.json();
  const div = document.getElementById('statsSummary');

  let detailedHtml = '';
  
  if (data.detailedByBrand && data.detailedByBrand.length > 0) {
    detailedHtml = '<h4>–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –±—Ä–µ–Ω–¥–∞–º:</h4>';
    data.detailedByBrand.forEach(brand => {
      detailedHtml += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; display: flex; align-items: center; min-height: 100px;">`;
      detailedHtml += `<div style="flex: 1;">`;
      detailedHtml += `<h5 style="margin: 0 0 10px 0; color: #c9b5ff; font-size: 18px; font-weight: 700; padding-left: 5px;">${brand.name}</h5>`;
      
      if (brand.screens && brand.screens.length > 0) {
        brand.screens.forEach(screen => {
          detailedHtml += `<div style="margin: 5px 0; padding: 5px; background: #linear-gradient(135deg, #181c2f 0%, #2a225a 50%, #3a1c71 100%); border-radius: 3px;">`;
          detailedHtml += `<strong>–≠–∫—Ä–∞–Ω:</strong> ${screen.screenId} | `;
          detailedHtml += `<strong>–ö–∞–º–ø–∞–Ω–∏—è:</strong> ${screen.campaignName} | `;
          detailedHtml += `<strong>–ü–æ–∫–∞–∑—ã:</strong> ${screen.impressions} | `;
          detailedHtml += `<strong>–ö–ª–∏–∫–∏:</strong> ${screen.clicks}`;
          detailedHtml += `</div>`;
        });
      } else {
        detailedHtml += `<p style="color: #666; font-style: italic;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —ç–∫—Ä–∞–Ω–∞–º</p>`;
      }
      detailedHtml += `</div>`;
      
      detailedHtml += `<div style="display: flex; align-items: center; margin-left: 20px;">`;
      // Fix: Escape single quotes in brand.name for JS string
      const safeBrandName = brand.name.replace(/'/g, "\\'");
      detailedHtml += `<button onclick="openBrandChart('${brand.brandId}', '${safeBrandName}')" class="btn btn-success">üìä –ü–æ–¥—Ä–æ–±–Ω–µ–µ</button>`;
      detailedHtml += `</div>`;
      detailedHtml += `</div>`;
    });
  }

  div.innerHTML = `
    <p><b>–í—Å–µ–≥–æ –ø–æ–∫–∞–∑–æ–≤:</b> ${data.total.impressions}</p>
    <p><b>–í—Å–µ–≥–æ –∫–ª–∏–∫–æ–≤:</b> ${data.total.clicks}</p>
    ${detailedHtml}
  `;
}


// ===== CHART FUNCTIONS =====
let brandChart = null;
let currentBrandId = null;

async function openBrandChart(brandId, brandName) {
  currentBrandId = brandId;
  document.getElementById('chartBrandName').textContent = brandName;
  document.getElementById('brandChartModal').style.display = 'block';
  await loadBrandChart();
}

async function loadBrandChart() {
  if (!currentBrandId) return;
  
  const period = document.getElementById('chartPeriod').value;
  
  try {
    const res = await authorizedFetch(`${API}/stats/brand/${currentBrandId}?days=${period}`);
    if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö');
    
    const data = await res.json();
    
    // Destroy existing chart
    if (brandChart) {
      brandChart.destroy();
    }
    
    // Create new chart
    const ctx = document.getElementById('brandChart').getContext('2d');
    brandChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          {
            label: '–ü–æ–∫–∞–∑—ã',
            data: data.impressions,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
          },
          {
            label: '–ö–ª–∏–∫–∏',
            data: data.clicks,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º',
            color: '#c9b5ff'
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Update details section
    updateChartDetails(data);
    
  } catch (error) {
    console.error('Chart error:', error);
    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞: ' + error.message);
  }
}

function updateChartDetails(data) {
  const detailsDiv = document.getElementById('brandChartDetails');
  
  let detailsHtml = '<h3 style="margin: 0 0 20px 0; color: #c9b5ff; border-bottom: 2px solid #007bff; padding-bottom: 10px;">üìà –û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</h3>';
  
  if (data.hasAllTimeData) {
    detailsHtml += '<div style="background: #0f0e19; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin-bottom: 20px; color: #c9b5ff;">‚ö†Ô∏è –ü–æ–∫–∞–∑–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞ –≤—Å–µ –≤—Ä–µ–º—è (–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥)</div>';
  }
  
  detailsHtml += `
    <div style="background: #0f0e19; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">–ü–æ–∫–∞–∑—ã:</span>
        <span style="font-size: 18px; font-weight: bold; color: #007bff;">${data.totalImpressions}</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">–ö–ª–∏–∫–∏:</span>
        <span style="font-size: 18px; font-weight: bold; color: #28a745;">${data.totalClicks}</span>
      </div>
      <div style="display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">CTR:</span>
        <span style="font-size: 18px; font-weight: bold; color: #ffc107;">${data.ctr}%</span>
      </div>
    </div>
  `;
  
  if (data.topScreens && data.topScreens.length > 0) {
    detailsHtml += '<h4 style="margin: 20px 0 15px 0; color: #c9b5ff;">üñ•Ô∏è –¢–æ–ø —ç–∫—Ä–∞–Ω–æ–≤</h4>';
    detailsHtml += '<div style="background: #0f0e19; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
    data.topScreens.forEach((screen, index) => {
      detailsHtml += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; ${index > 0 ? 'border-top: 1px solid #333;' : ''}">
          <div style="font-weight: 500; color: #c9b5ff; max-width: 60%; word-break: break-word;">${screen.screenName || screen.screenId || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —ç–∫—Ä–∞–Ω'}</div>
          <div style="text-align: right; min-width: 120px;">
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${screen.impressions} –ø–æ–∫–∞–∑–æ–≤</span>
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${screen.clicks} –∫–ª–∏–∫–æ–≤</span>
          </div>
        </div>
      `;
    });
    detailsHtml += '</div>';
  }
  
  if (data.topCampaigns && data.topCampaigns.length > 0) {
    detailsHtml += '<h4 style="margin: 20px 0 15px 0; color: #c9b5ff;">üéØ –¢–æ–ø –∫–∞–º–ø–∞–Ω–∏–π</h4>';
    detailsHtml += '<div style="background: #0f0e19; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
    data.topCampaigns.forEach((campaign, index) => {
      detailsHtml += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; ${index > 0 ? 'border-top: 1px solid #333;' : ''}">
          <div style="font-weight: 500; color: #c9b5ff; max-width: 60%; word-break: break-word;">${campaign.name}</div>
          <div style="text-align: right; min-width: 120px;">
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${campaign.impressions} –ø–æ–∫–∞–∑–æ–≤</span>
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${campaign.clicks} –∫–ª–∏–∫–æ–≤</span>
          </div>
        </div>
      `;
    });
    detailsHtml += '</div>';
  }
  
  detailsDiv.innerHTML = detailsHtml;
}

function closeBrandChartModal() {
  document.getElementById('brandChartModal').style.display = 'none';
  if (brandChart) {
    brandChart.destroy();
    brandChart = null;
  }
  currentBrandId = null;
}

// ===== QR CODE FUNCTIONS =====
async function generateQRCode(campaignId) {
  try {
    console.log('Generating QR code for campaign:', campaignId);
    
    // First get campaign info to find screens
    const campaignRes = await authorizedFetch(`${API}/campaigns/${campaignId}`);
    if (!campaignRes.ok) throw new Error('Failed to get campaign');
    const campaign = await campaignRes.json();
    
    // Get all screens for this brand
    const screensRes = await authorizedFetch(`${API}/screens`);
    if (!screensRes.ok) throw new Error('Failed to get screens');
    const screens = await screensRes.json();
    
    const brandScreens = screens.filter(s => s.brandId === campaign.brandId);
    
    if (brandScreens.length === 0) {
      alert('–ù–µ—Ç —ç–∫—Ä–∞–Ω–æ–≤ –¥–ª—è —ç—Ç–æ–≥–æ –±—Ä–µ–Ω–¥–∞. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ —ç–∫—Ä–∞–Ω.');
      return;
    }
    
    // Create screen selection modal for multiple screens
    let selectedScreen = brandScreens[0];
    
    if (brandScreens.length > 1) {
      // Create screen selection modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      `;
      
      modal.innerHTML = `
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;">
          <h3>–í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Ä–∞–Ω –¥–ª—è QR –∫–æ–¥–∞</h3>
          <p style="color: #666; margin-bottom: 20px;">–í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Ä–∞–Ω, –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å QR –∫–æ–¥:</p>
          <div style="margin-bottom: 20px;">
            ${brandScreens.map(screen => `
              <div style="margin: 10px 0; padding: 10px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;" 
                   onclick="selectScreenForQR('${screen.screenId}', '${campaignId}', this.parentElement.parentElement.parentElement.parentElement)">
                <strong>–≠–∫—Ä–∞–Ω:</strong> ${screen.screenId}
                ${screen.currentCampaignId ? `<br><small>–¢–µ–∫—É—â–∞—è –∫–∞–º–ø–∞–Ω–∏—è: ${screen.currentCampaignId}</small>` : ''}
              </div>
            `).join('')}
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="btn btn-danger">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;
      
      document.body.appendChild(modal);
      return; // Exit here, let the modal handle the selection
    }
    
    console.log('Using screen for QR:', selectedScreen.screenId);
    
    // Generate QR code for single screen
    await generateQRForScreen(selectedScreen.screenId, campaignId);
  } catch (error) {
    console.error('QR code generation error:', error);
    alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞: ' + error.message);
  }
}

async function selectScreenForQR(screenId, campaignId, modalElement) {
  try {
    console.log('Generating QR code for screen:', screenId, 'campaign:', campaignId);
    
    // Remove the selection modal
    modalElement.remove();
    
    // Generate QR code for selected screen
    await generateQRForScreen(screenId, campaignId);
    
  } catch (error) {
    console.error('QR code generation error:', error);
    alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞: ' + error.message);
  }
}

async function generateQRForScreen(screenId, campaignId) {
  try {
    console.log('Starting QR generation for screen:', screenId, 'campaign:', campaignId);
    
    // Ensure DOM is ready
    if (document.readyState !== 'complete' && document.readyState !== 'interactive') {
      console.log('DOM not ready, waiting...');
      await new Promise(resolve => {
        document.addEventListener('DOMContentLoaded', resolve, { once: true });
      });
    }
    
    // Use authorizedFetch but with error handling for extension interference
    console.log('Making API call to:', `${API}/tracking/qr/${campaignId}?screenId=${screenId}`);
    const res = await authorizedFetch(`${API}/tracking/qr/${campaignId}?screenId=${screenId}`);
    
    console.log('Response status:', res.status);
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('Server error:', errorText);
      throw new Error(`HTTP ${res.status}: ${errorText}`);
    }
    
    const data = await res.json();
    console.log('QR data received:', data);
    
    // Validate data structure
    if (!data || !data.qrData || !data.qrData.url || !data.qrData.params) {
      console.error('Invalid QR data structure:', data);
      throw new Error('Invalid QR data structure received from server');
    }
    
    // Create QR code container
    const qrContainer = document.createElement('div');
    qrContainer.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 2000;
      text-align: center;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
    `;
    
    const uniqueId = 'qrcode_' + Date.now();
    qrContainer.innerHTML = `
      <h3>QR –∫–æ–¥ –¥–ª—è —ç–∫—Ä–∞–Ω–∞: ${screenId}</h3>
      <div id="${uniqueId}" style="margin: 20px 0;"></div>
      <p style="margin-top: 15px; font-size: 12px; color: #666;">
        Tracking ID: ${data.trackingId}
      </p>
      <p style="font-size: 11px; color: #999; margin-top: 10px;">
        URL: ${new URL(data.qrData.url, window.location.origin).toString()}
      </p>
      <button onclick="this.parentElement.remove(); location.reload();" class="btn btn-danger" style="margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
    `;
    
    // Ensure document.body exists before appending
    let container = document.body;
    if (!container) {
      // Try to append to the first available container
      container = document.querySelector('body') || document.documentElement || document;
      if (!container || !container.appendChild) {
        throw new Error('No suitable container found for QR code');
      }
    }
    container.appendChild(qrContainer);
    
    // Generate QR code with error handling
    try {
      const qrElement = document.getElementById(uniqueId);
      if (qrElement) {
        // Check if QRCode library is available
        if (typeof QRCode !== 'undefined') {
          // Build the actual URL with parameters
          const url = new URL(data.qrData.url, window.location.origin);
          Object.keys(data.qrData.params).forEach(key => {
            url.searchParams.set(key, data.qrData.params[key]);
          });
          
          new QRCode(qrElement, {
            text: url.toString(),
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        } else {
          // Fallback: use simple QR generation
          console.log('Using fallback QR generation');
          const url = new URL(data.qrData.url, window.location.origin);
          Object.keys(data.qrData.params).forEach(key => {
            url.searchParams.set(key, data.qrData.params[key]);
          });
          window.generateSimpleQR(url.toString(), uniqueId);
        }
      } else {
        throw new Error('QR element not found');
      }
    } catch (qrError) {
      console.error('QR generation error:', qrError);
      const errorElement = document.getElementById(uniqueId);
      if (errorElement) {
        errorElement.innerHTML = `
          <div style="color: #666; padding: 20px; background: #f9f9f9; border-radius: 8px; font-family: monospace; font-size: 12px;">
            <h4>QR Code Data (Library not available)</h4>
            <p><strong>URL:</strong> ${data.qrData.url}</p>
            <p><strong>Screen:</strong> ${screenId}</p>
            <p><strong>Data:</strong></p>
            <pre style="background: white; padding: 10px; border-radius: 4px; overflow-x: auto;">${JSON.stringify(data.qrData.params, null, 2)}</pre>
          </div>
        `;
      }
    }
    
  } catch (error) {
    console.error('QR code generation error:', error);
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      screenId: screenId,
      campaignId: campaignId
    });
    alert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
  }
}

// ===== POPULATE FUNCTIONS =====
async function populateBrandsForCampaign() {
  try {
    const res = await authorizedFetch(`${API}/brands`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    const select = document.getElementById('campaignBrandSelect');
    select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥</option>';
    const brands = Array.isArray(data) ? data : [];
    brands.forEach(b => {
      const option = document.createElement('option');
      option.value = b._id;
      option.textContent = b.name;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error populating brands for campaign:', error);
  }
}

async function populateScreens() {
  try {
    const res = await authorizedFetch(`${API}/screens`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const screens = await res.json();
    
    const selectScreen = document.getElementById('selectScreen');
    if (selectScreen) {
      selectScreen.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —ç–∫—Ä–∞–Ω</option>';
      screens.forEach(screen => {
        selectScreen.innerHTML += `<option value="${screen.screenId}">${screen.screenId}</option>`;
      });
    }
  } catch (error) {
    console.error('Error populating screens:', error);
  }
}

async function populateCampaigns() {
  try {
    const res = await authorizedFetch(`${API}/campaigns`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const campaigns = await res.json();
    
    const selectCampaign = document.getElementById('selectCampaign');
    if (selectCampaign) {
      selectCampaign.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é</option>';
      campaigns.forEach(campaign => {
        selectCampaign.innerHTML += `<option value="${campaign._id}">${campaign.name}</option>`;
      });
    }
  } catch (error) {
    console.error('Error populating campaigns:', error);
  }
}

// ===== CLEAR STATISTICS FUNCTIONS =====
function showClearStatsModal() {
  document.getElementById('clearStatsModal').style.display = 'block';
  populateClearStatsDropdowns();
}

function closeClearStatsModal() {
  document.getElementById('clearStatsModal').style.display = 'none';
}

async function populateClearStatsDropdowns() {
  try {
    // Populate brands dropdown
    const brandsRes = await authorizedFetch(`${API}/brands`);
    if (brandsRes.ok) {
      const brands = await brandsRes.json();
      const brandSelect = document.getElementById('clearBrandSelect');
      brandSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥...</option>';
      brands.forEach(brand => {
        brandSelect.innerHTML += `<option value="${brand._id}">${brand.name}</option>`;
      });
    }

    // Populate campaigns dropdown
    const campaignsRes = await authorizedFetch(`${API}/campaigns`);
    if (campaignsRes.ok) {
      const campaigns = await campaignsRes.json();
      const campaignSelect = document.getElementById('clearCampaignSelect');
      campaignSelect.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é...</option>';
      campaigns.forEach(campaign => {
        campaignSelect.innerHTML += `<option value="${campaign._id}">${campaign.name}</option>`;
      });
    }
  } catch (error) {
    console.error('Error populating clear stats dropdowns:', error);
  }
}

// Handle radio button changes
document.addEventListener('change', function(e) {
  if (e.target.name === 'clearType') {
    const brandSelect = document.getElementById('clearBrandSelect');
    const campaignSelect = document.getElementById('clearCampaignSelect');
    
    if (e.target.value === 'brand') {
      brandSelect.style.display = 'inline-block';
      campaignSelect.style.display = 'none';
    } else if (e.target.value === 'campaign') {
      brandSelect.style.display = 'none';
      campaignSelect.style.display = 'inline-block';
    } else {
      brandSelect.style.display = 'none';
      campaignSelect.style.display = 'none';
    }
  }
});

async function clearStats() {
  const clearType = document.querySelector('input[name="clearType"]:checked').value;
  let targetId = '';
  let targetName = '';

  if (clearType === 'brand') {
    targetId = document.getElementById('clearBrandSelect').value;
    if (!targetId) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –±—Ä–µ–Ω–¥');
      return;
    }
    targetName = document.getElementById('clearBrandSelect').options[document.getElementById('clearBrandSelect').selectedIndex].text;
  } else if (clearType === 'campaign') {
    targetId = document.getElementById('clearCampaignSelect').value;
    if (!targetId) {
      alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞–º–ø–∞–Ω–∏—é');
      return;
    }
    targetName = document.getElementById('clearCampaignSelect').options[document.getElementById('clearCampaignSelect').selectedIndex].text;
  }

  const confirmMessage = clearType === 'all' 
    ? '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –í–°–Æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.'
    : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è "${targetName}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`;

  if (!confirm(confirmMessage)) {
    return;
  }

  try {
    let url = `${API}/stats`;
    if (clearType === 'brand') {
      url += `/brand/${targetId}`;
    } else if (clearType === 'campaign') {
      url += `/campaign/${targetId}`;
    }

    const response = await authorizedFetch(url, {
      method: 'DELETE'
    });

    if (response.ok) {
      const result = await response.json();
      alert(`‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—á–∏—â–µ–Ω–∞!\n\n${result.message || '–£–¥–∞–ª–µ–Ω–æ –∑–∞–ø–∏—Å–µ–π: ' + (result.deletedCount || 0)}`);
      closeClearStatsModal();
      loadStats(); // Refresh stats display
    } else {
      const error = await response.json();
      alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + (error.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    }
  } catch (error) {
    console.error('Error clearing stats:', error);
    alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + error.message);
  }
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  loadBrands();
  loadScreens();
  populateScreens();
  populateCampaigns();
  loadCampaignsList();
  loadStats();
  populateBrandsForCampaign(); // <-- Ensure this is called after DOM is ready
});
</script>

</body>
</html>
