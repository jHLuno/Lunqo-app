<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Админ-панель - Lunqo Digital Out-of-Home Advertising Platform</title>
  <meta name="description" content="Административная панель Lunqo для управления цифровой наружной рекламой. Управляйте брендами, кампаниями, экранами и аналитикой в одном месте.">
  <meta name="keywords" content="админ панель, управление рекламой, digital advertising, out-of-home advertising, DOOH, smart screens, brand campaigns, advertising platform, Lunqo">
  <meta name="author" content="Lunqo">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
  <link rel="icon" href="/favicons/favicon.ico">
  <!-- Font Preloading for Performance -->
  <link rel="preload" href="/fonts/SF-Pro-Display-Regular.otf" as="font" type="font/otf" crossorigin>
  <link rel="preload" href="/fonts/SF-Pro-Display-Medium.otf" as="font" type="font/otf" crossorigin>
  <link rel="preload" href="/fonts/SF-Pro-Display-Bold.otf" as="font" type="font/otf" crossorigin>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <style>
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
      font-display: block;
    }
    
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Medium.otf') format('opentype');
      font-weight: 500;
      font-style: normal;
      font-display: block;
    }
    
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Bold.otf') format('opentype');
      font-weight: 700;
      font-style: normal;
      font-display: block;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #050505 0%, #0a0a0a 25%, #0d1117 50%, #161b22 75%, #1a1a2e 100%);
      color: #ffffff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .main-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
      position: relative;
    }
    
    /* Background Effects */
    .main-wrapper::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 25% 25%, rgba(24, 160, 251, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(89, 255, 112, 0.05) 0%, transparent 50%);
      background-size: 100px 100px, 150px 150px;
      opacity: 0.3;
      z-index: -1;
    }
    
    /* Floating Elements */
    .floating-element {
      position: fixed;
      border-radius: 8px;
      opacity: 0.05;
      animation: float 8s ease-in-out infinite;
      z-index: -1;
    }
    
    .floating-element:nth-child(1) {
      top: 15%;
      left: 5%;
      width: 60px;
      height: 40px;
      background: linear-gradient(135deg, rgba(24, 160, 251, 0.2), rgba(89, 255, 112, 0.2));
      border: 1px solid rgba(24, 160, 251, 0.3);
      animation-delay: 0s;
    }
    
    .floating-element:nth-child(2) {
      top: 70%;
      right: 10%;
      width: 40px;
      height: 30px;
      background: linear-gradient(135deg, rgba(89, 255, 112, 0.2), rgba(255, 122, 69, 0.2));
      border: 1px solid rgba(89, 255, 112, 0.3);
      animation-delay: 3s;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-15px) rotate(3deg); }
    }
    
    /* Enhanced table styling */
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 24px;
      background: rgba(33, 37, 41, 0.8);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    table:hover {
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
    }
    
    h1, h2, h3, h4 {
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-top: 0;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #18A0FB, #59FF70);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2 {
      font-size: 1.8rem;
      margin-top: 48px;
      margin-bottom: 24px;
      background: linear-gradient(135deg, #18A0FB, #59FF70);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .section-card {
      background: rgba(33, 37, 41, 0.5);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(52, 58, 64, 0.5);
      border-radius: 24px;
      padding: 40px;
      margin: 40px auto 0 auto;
      max-width: 1200px;
      width: 100%;
      position: relative;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 20px rgba(24, 160, 251, 0.1);
      transition: all 0.3s ease;
    }
    
    .section-card:hover {
      border-color: rgba(24, 160, 251, 0.3);
      box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 30px rgba(24, 160, 251, 0.2);
    }
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 24px;
      background: rgba(33, 37, 41, 0.8);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    th, td {
      padding: 20px 16px;
      border-bottom: 1px solid rgba(52, 58, 64, 0.5);
      text-align: left;
    }
    
    th {
      background: rgba(24, 160, 251, 0.1);
      color: #18A0FB;
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 0.01em;
      border-bottom: 2px solid rgba(24, 160, 251, 0.3);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background: rgba(24, 160, 251, 0.05);
    }
    input, select, textarea {
      padding: 16px 20px;
      border: 2px solid rgba(52, 58, 64, 0.8);
      border-radius: 12px;
      font-size: 1rem;
      margin: 8px 0 16px 0;
      background: rgba(33, 37, 41, 0.8);
      color: #ffffff;
      transition: all 0.3s ease;
      outline: none;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: #18A0FB;
      background: rgba(33, 37, 41, 0.9);
      box-shadow: 0 0 20px rgba(24, 160, 251, 0.3);
    }
    
    input::placeholder, textarea::placeholder {
      color: #6c757d;
    }
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      cursor: pointer;
      margin: 8px 8px 8px 0;
      transition: all 0.3s ease;
      outline: none;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #59FF70, #38f9d7);
      color: #ffffff;
      box-shadow: 0 4px 20px rgba(89, 255, 112, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .btn-danger {
      background: linear-gradient(135deg, #FF7A45, #a83279) !important;
      color: #ffffff !important;
      box-shadow: 0 4px 20px rgba(255, 122, 69, 0.3) !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }
    
    .btn, .btn-main {
      background: linear-gradient(135deg, #18A0FB, #59FF70);
      color: #ffffff;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(24, 160, 251, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .btn-logout {
      background: linear-gradient(135deg, #FF7A45, #a83279);
      color: #ffffff;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 24px;
      margin-top: 0;
      float: right;
      box-shadow: 0 4px 20px rgba(255, 122, 69, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    .btn-details {
      background: linear-gradient(135deg, #18A0FB, #4e54c8);
      color: #ffffff;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(24, 160, 251, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .btn:hover, .btn-success:hover, .btn-main:hover, .btn-logout:hover, .btn-details:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 25px rgba(24, 160, 251, 0.3);
    }
    
    .btn-success:hover {
      box-shadow: 0 6px 25px rgba(89, 255, 112, 0.3);
    }
    
    .btn-danger:hover, .btn-logout:hover {
      box-shadow: 0 6px 25px rgba(255, 122, 69, 0.3);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
    }
    
    .modal-content {
      background: rgba(33, 37, 41, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(52, 58, 64, 0.5);
      margin: 3% auto;
      padding: 40px 32px 32px 32px;
      border-radius: 24px !important;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(24, 160, 251, 0.2);
      max-width: 440px;
      width: 97%;
      color: #ffffff;
    }
    .modal-input {
      width: 100%;
      margin: 10px 0 20px 0;
      padding: 14px;
      border: 1.5px solid #3a2d6a;
      border-radius: 9px;
      font-size: 1rem;
      background: #181c2f;
      color: #e6e6f0;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    .btn-right {
      text-align: right;
      margin-top: 20px;
    }
    hr {
      border: none;
      border-top: 2px solid #2a225a;
      margin: 40px 0 28px 0;
    }
    .stat-block {
      background: rgba(33, 37, 41, 0.6);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(52, 58, 64, 0.3);
      border-radius: 16px;
      padding: 24px 32px;
      transition: all 0.3s ease;
    }
    
    .stat-block:hover {
      border-color: rgba(24, 160, 251, 0.2);
      transform: translateY(-2px);
    }
      margin: 22px 0;
      color: #b7aaff;
      font-size: 1.13rem;
      box-shadow: 0 2px 8px #3a1c7144;
    }
    .stat-title {
      font-weight: 700;
      color: #a084ff;
      margin-bottom: 10px;
    }
    .stat-detail {
      margin-left: 22px;
      color: #e6e6f0;
      font-size: 1.01rem;
    }
    .stat-brand {
      margin-top: 16px;
      font-weight: 500;
      color: #e0d7ff;
    }
    .stat-screen {
      margin-left: 28px;
      color: #a084ff;
      font-size: 1.01rem;
    }
    .stat-campaign {
      margin-left: 40px;
      color: #e6e6f0;
      font-size: 0.99rem;
    }
    .stat-btn {
      float: right;
      margin-top: -8px;
    }
    .checkbox, .radio {
      accent-color: #a084ff;
      width: 20px;
      height: 20px;
      margin-right: 10px;
      background: #23203a;
      border-radius: 4px;
      border: 1.5px solid #3a2d6a;
    }
    
    /* QR Code Modal Specific Styles */
    .qr-modal {
      background: #ffffff !important;
      color: #333333 !important;
    }
    
    .qr-modal h3 {
      color: #333333 !important;
      background: none !important;
      -webkit-background-clip: unset !important;
      -webkit-text-fill-color: unset !important;
    }
    
    .qr-modal p {
      color: #666666 !important;
    }
    
    .qr-modal .btn {
      background: linear-gradient(135deg, #18A0FB, #59FF70);
      color: #ffffff !important;
    }
    
    /* Additional styles for QR modal content to ensure text visibility */
    .qr-modal div,
    .qr-modal span,
    .qr-modal strong {
      color: #333333 !important;
    }
    
    /* Style for screen selection items in QR modal */
    .qr-modal div[style*="border: 1px solid #ddd"] {
      background: #f8f9fa !important;
      color: #333333 !important;
    }
    
    .qr-modal div[style*="border: 1px solid #ddd"]:hover {
      background: #e9ecef !important;
    }
    
    .qr-modal small {
      color: #666666 !important;
    }
    
    @media (max-width: 1100px) {
      .main-wrapper, .section-card {
        max-width: 98vw;
        padding: 12px 2vw 12px 2vw;
      }
      .modal-content {
        padding: 18px 2vw 12px 2vw;
      }
      table th, table td {
        padding: 8px 4px;
      }
    }
    @media (max-width: 700px) {
      .main-wrapper, .section-card {
        padding: 6px 1vw 6px 1vw;
        margin: 18px auto 0 auto;
      }
      h1 {
        font-size: 1.3rem;
      }
      .modal-content {
        padding: 8px 1vw 8px 1vw;
      }
      table th, table td {
        padding: 5px 2px;
        font-size: 0.92rem;
      }
      button, .btn, .btn-main, .btn-logout, .btn-details {
        padding: 10px 10px;
        font-size: 0.98rem;
      }
      input, select, textarea, .modal-input {
        font-size: 0.95rem;
        padding: 8px 8px;
      }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script>
    // Utility function to escape HTML to prevent XSS
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Utility function to safely create HTML elements
    function createSafeElement(tag, attributes = {}, textContent = '') {
      const element = document.createElement(tag);
      Object.keys(attributes).forEach(key => {
        if (key === 'onclick') {
          // For onclick, we need to be extra careful - only allow specific patterns
          const value = attributes[key];
          if (typeof value === 'string' && /^[a-zA-Z0-9_]+\(['"][^'"]*['"]\)$/.test(value)) {
            element.setAttribute(key, value);
          }
        } else {
          element.setAttribute(key, escapeHtml(attributes[key]));
        }
      });
      if (textContent) {
        element.textContent = textContent;
      }
      return element;
    }

    function generateQRCode(text) {
      const element = document.getElementById('qrCodeDisplay');
      if (!element) return;
      
      // Create a simple text representation using safe DOM manipulation
      element.innerHTML = '';
      
      const qrContainer = document.createElement('div');
      qrContainer.style.cssText = 'border: 2px solid #333; padding: 20px; display: inline-block; background: white;';
      
      const qrText = document.createElement('div');
      qrText.style.cssText = 'font-family: monospace; font-size: 10px; line-height: 1;';
      qrText.textContent = text;
      
      const infoText = document.createElement('p');
      infoText.style.cssText = 'margin-top: 10px; color: #666; font-size: 12px;';
      infoText.textContent = `QR Code Data: ${text.substring(0, 50)}...`;
      
      qrContainer.appendChild(qrText);
      element.appendChild(qrContainer);
      element.appendChild(infoText);
    };
  </script>
  <script>
  const token = localStorage.getItem('token');
  const isAdmin = localStorage.getItem('isAdmin');
  if (!token || isAdmin !== 'true') {
    alert('🚫 Доступ только для администратора!');
    location.href = '/admin-login.html';
  }
  </script>
</head>
<body>
<!-- Floating Elements -->
<div class="floating-element"></div>
<div class="floating-element"></div>

<div class="main-wrapper">

<button onclick="logout()" class="btn-logout">Выйти</button>
<script>
  function logout() {
    localStorage.clear();
    window.location.replace('/admin-login.html');
  }
</script>
  
<!-- ===== BRANDS SECTION ===== -->
<h1>Бренды</h1>
<div>
  <input type="text" id="brandName" placeholder="Название бренда">
  <input type="email" id="brandEmail" placeholder="Email">
  <input type="password" id="brandPassword" placeholder="Пароль">
  <button onclick="createBrand()" class="btn-main">Создать бренд</button>
</div>

<table id="brandsTable">
  <thead>
    <tr>
      <th>Название</th>
      <th>Email</th>
      <th>ID</th>
      <th>Пароль</th>
      <th>Действия</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Brand Edit Modal -->
<div id="editBrandModal" class="modal" onclick="closeEditModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="margin-top: 0;">Редактировать бренд</h3>
    <input type="hidden" id="editBrandId">
    <input type="text" id="editBrandName" placeholder="Название бренда" class="modal-input"><br>
    <input type="email" id="editBrandEmail" placeholder="Email" class="modal-input"><br>
    <input type="password" id="editBrandPassword" placeholder="Пароль" class="modal-input"><br>
    <div class="btn-right">
      <button onclick="saveBrandEdit()" class="btn btn-success">Сохранить</button>
      <button onclick="closeEditModal()" class="btn btn-danger">Отмена</button>
    </div>
  </div>
</div>

<hr>

<!-- ===== SCREENS SECTION ===== -->
<h1>Экраны</h1>
<div>
  <input type="text" id="screenId" placeholder="ID экрана">
  <input type="text" id="screenBrandId" placeholder="ID бренда">
  <button onclick="createScreen()" class="btn-main">Создать экран</button>
</div>

<div style="margin: 20px 0; padding: 15px; background: rgba(33, 37, 41, 0.5); border-radius: 12px;">
  <h3 style="margin-top: 0; color: #18A0FB;">Массовое управление</h3>
  <button onclick="bulkToggleScreens(true)" class="btn-success">🟢 Включить все экраны</button>
  <button onclick="bulkToggleScreens(false)" class="btn-danger">🔴 Выключить все экраны</button>
  <p style="font-size: 0.9rem; color: #a084ff; margin-top: 10px;">
    Управляйте всеми экранами одновременно. Включенные экраны отображают контент, выключенные - нет.
  </p>
</div>

<table id="screensTable">
  <thead>
    <tr>
      <th>ID экрана</th>
      <th>Бренд</th>
      <th>Кампания</th>
      <th>Статус</th>
      <th>Действия</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<!-- Screen Edit Modal -->
<div id="editScreenModal" class="modal" onclick="closeScreenEditModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="margin-top: 0;">Редактировать экран</h3>
    <input type="hidden" id="editScreenId">
    <input type="text" id="editScreenScreenId" placeholder="ID экрана" class="modal-input"><br>
    <input type="text" id="editScreenBrandId" placeholder="ID бренда" class="modal-input"><br>
    <div style="margin: 10px 0;">
      <label style="color: #c9b5ff; font-weight: 500; display: flex; align-items: center; gap: 8px;">
        <input type="checkbox" id="editScreenIsOnline" class="checkbox" checked>
        Экран онлайн (включен)
      </label>
    </div>
    <div class="btn-right">
      <button onclick="saveScreenEdit()" class="btn btn-success">Сохранить</button>
      <button onclick="closeScreenEditModal()" class="btn btn-danger">Отмена</button>
    </div>
  </div>
</div>

<hr>

<!-- ===== CAMPAIGNS SECTION ===== -->
<h1>Создание кампании</h1>
<div>
  <input type="text" id="campaignName" placeholder="Название кампании"><br><br>

  <label>Бренд:</label>
  <select id="campaignBrandSelect"></select><br><br>

  <label>Дата начала:</label>
  <input type="date" id="campaignStart">
  <label>Дата окончания:</label>
  <input type="date" id="campaignEnd"><br><br>

  <textarea id="campaignVideos" rows="4" cols="60" placeholder="Одна ссылка на видео в строке..."></textarea><br><br>

  <label>Промо URL:</label>
  <input type="url" id="campaignPromoUrl" placeholder="https://example.com/promo" style="width: 300px;"><br><br>

  <button onclick="createCampaign()" class="btn-main">Создать кампанию</button>
</div>

<hr>
<h1>Список кампаний</h1>
<div id="campaignList"></div>

<!-- Campaign Edit Modal -->
<div id="editCampaignModal" class="modal" onclick="closeCampaignEditModal()">
  <div class="modal-content" onclick="event.stopPropagation()">
    <h3 style="margin-top: 0;">Редактировать кампанию</h3>
    <input type="hidden" id="editCampaignId">
    <input type="text" id="editCampaignName" placeholder="Название кампании" class="modal-input"><br>
    <label>Дата начала:</label>
    <input type="date" id="editCampaignStart" class="modal-input"><br>
    <label>Дата окончания:</label>
    <input type="date" id="editCampaignEnd" class="modal-input"><br>
    <label>Промо URL:</label>
    <input type="url" id="editCampaignPromoUrl" placeholder="https://example.com/promo" class="modal-input"><br>
    <label>Ссылки на видео:</label><br>
    <textarea id="editCampaignVideos" rows="4" class="modal-input"></textarea><br>
    <div class="btn-right">
      <button onclick="saveCampaignEdit()" class="btn btn-success">Сохранить</button>
      <button onclick="closeCampaignEditModal()" class="btn btn-danger">Отмена</button>
    </div>
  </div>
</div>

<hr>

<!-- ===== CAMPAIGN ASSIGNMENT SECTION ===== -->
<h1>Привязка кампании к экрану</h1>
<div>
  <label>Экран:</label>
  <select id="selectScreen"></select>

  <label>Кампания:</label>
  <select id="selectCampaign"></select>

  <button onclick="assignCampaign()" class="btn-main">Назначить</button>
</div>

<hr style="border: none; height: 2px; background: linear-gradient(135deg, #18A0FB, #59FF70); margin: 40px auto; max-width: 1200px; border-radius: 1px; opacity: 0.6;">

<div class="section-card">
  <h1>Статистика</h1>
  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button onclick="loadStats()" class="btn btn-success">🔄 Обновить</button>
    <button onclick="showClearStatsModal()" class="btn btn-danger">🗑️ Очистить статистику</button>
  </div>
  <div id="statsSummary"></div>
</div>

<!-- Clear Statistics Modal -->
<div id="clearStatsModal" class="modal">
  <div class="modal-content" style="width: 500px; max-width: 90%;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
      <h3 style="margin: 0; color: #333;">🗑️ Очистить статистику</h3>
      <button onclick="closeClearStatsModal()" class="btn btn-danger" style="margin: 0;">✕ Закрыть</button>
    </div>
    
    <div style="margin-bottom: 20px;">
      <label style="display: block; margin-bottom: 10px; font-weight: bold;">Выберите что очистить:</label>
      
      <div style="margin-bottom: 15px;">
        <input type="radio" id="clearAll" name="clearType" value="all" checked>
        <label for="clearAll">Всю статистику</label>
      </div>
      
      <div style="margin-bottom: 15px;">
        <input type="radio" id="clearBrand" name="clearType" value="brand">
        <label for="clearBrand">Статистику бренда</label>
        <select id="clearBrandSelect" style="margin-left: 10px; padding: 5px; display: none;">
          <option value="">Выберите бренд...</option>
        </select>
      </div>
      
      <div style="margin-bottom: 15px;">
        <input type="radio" id="clearCampaign" name="clearType" value="campaign">
        <label for="clearCampaign">Статистику кампании</label>
        <select id="clearCampaignSelect" style="margin-left: 10px; padding: 5px; display: none;">
          <option value="">Выберите кампанию...</option>
        </select>
      </div>
    </div>
    
    <div style="text-align: center;">
      <button onclick="clearStats()" class="btn btn-danger">🗑️ Очистить</button>
      <button onclick="closeClearStatsModal()" class="btn" style="margin-left: 10px;">Отмена</button>
    </div>
  </div>
</div>

<!-- Brand Details Chart Modal -->
<div id="brandChartModal" class="modal" onclick="closeBrandChartModal()">
  <div class="modal-content" style="width: 95%; max-width: 1200px; margin: 2% auto; border-radius: 15px !important; overflow: hidden;" onclick="event.stopPropagation()">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
      <h2 style="margin: 0; color: #c9b5ff; font-size: 24px;">📊 Детальная статистика: <span id="chartBrandName" style="color: #007bff;"></span></h2>
      <button onclick="closeBrandChartModal()" class="btn btn-danger" style="margin: 0;">✕ Закрыть</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 30px; margin-bottom: 30px; min-height: 500px;">
      <!-- Chart Section -->
      <div style="background: #0f0e19; padding: 20px; border-radius: 10px; overflow: hidden;">
        <div style="margin-bottom: 20px;">
          <label style="font-weight: bold; margin-right: 10px; color: #c9b5ff;">📅 Период:</label>
          <select id="chartPeriod" onchange="loadBrandChart()" style="padding: 8px 15px; border: 1px solid #c9b5ff; border-radius: 5px; background: #23203a;">
            <option value="7">Последние 7 дней</option>
            <option value="30">Последние 30 дней</option>
            <option value="90">Последние 3 месяца</option>
            <option value="365">Последний год</option>
          </select>
        </div>
        
        <div style="background: #0f0e19; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
          <canvas id="brandChart" width="400" height="400" style="max-width: 100%; height: auto;"></canvas>
        </div>
      </div>
      
      <!-- Stats Section -->
      <div id="brandChartDetails" style="background: #0f0e19; padding: 20px; border-radius: 10px; height: fit-content; overflow: hidden;"></div>
    </div>
  </div>
</div>

<script>
const API = '/api/admin';

// ===== UTILITY FUNCTIONS =====
function authorizedFetch(url, options = {}) {
  const token = localStorage.getItem('token');
  return fetch(url, {
    ...options,
    headers: {
      'Authorization': 'Bearer ' + token,
      ...(options.headers || {})
    }
  });
}

// ===== BRAND FUNCTIONS =====
async function loadBrands() {
  try {
  const res = await authorizedFetch(`${API}/brands`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
    
  const table = document.querySelector("#brandsTable tbody");
  table.innerHTML = "";
    
    const brands = Array.isArray(data) ? data : [];
    brands.forEach(brand => {
      const row = document.createElement('tr');
      
      const nameCell = document.createElement('td');
      nameCell.textContent = brand.name || 'N/A';
      
      const emailCell = document.createElement('td');
      emailCell.textContent = brand.email || 'N/A';
      
      const idCell = document.createElement('td');
      idCell.textContent = brand._id || 'N/A';
      
      const passwordCell = document.createElement('td');
      passwordCell.textContent = brand.password || 'N/A';
      
      const actionsCell = document.createElement('td');
      
      const editBtn = createSafeElement('button', {
        class: 'btn-details',
        onclick: `editBrand('${escapeHtml(brand._id)}')`
      }, '✏️ Изменить');
      
      const deleteBtn = createSafeElement('button', {
        class: 'btn-danger',
        onclick: `deleteBrand('${escapeHtml(brand._id)}')`
      }, '🗑 Удалить');
      
      actionsCell.appendChild(editBtn);
      actionsCell.appendChild(deleteBtn);
      
      row.appendChild(nameCell);
      row.appendChild(emailCell);
      row.appendChild(idCell);
      row.appendChild(passwordCell);
      row.appendChild(actionsCell);
      
      table.appendChild(row);
  });
  } catch (error) {
    alert('Ошибка загрузки брендов: ' + error.message);
  }
}

async function createBrand() {
  try {
  const name = document.getElementById('brandName').value;
  const email = document.getElementById('brandEmail').value;
    const password = document.getElementById('brandPassword').value;
    if (!name || !email || !password) return alert('Введите имя, email и пароль');
    
    const res = await authorizedFetch(`${API}/brands`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password })
    });
    
    //if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || `HTTP error ${res.status}`);
    }
  alert('✅ Бренд создан');
    document.getElementById('brandName').value = '';
    document.getElementById('brandEmail').value = '';
    document.getElementById('brandPassword').value = '';
    loadBrands(); 
    populateBrandsForCampaign();
  } catch (error) {
    alert('Ошибка создания бренда: ' + error.message);
  }
}

async function editBrand(id) {
  try {
    const res = await authorizedFetch(`${API}/brands/${id}`);
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    const brand = await res.json();
    document.getElementById('editBrandId').value = brand._id;
    document.getElementById('editBrandName').value = brand.name || '';
    document.getElementById('editBrandEmail').value = brand.email || '';
    document.getElementById('editBrandPassword').value = brand.password || '';
    document.getElementById('editBrandModal').style.display = 'block';
  } catch (error) {
    alert('Ошибка загрузки данных бренда: ' + error.message);
  }
}

async function saveBrandEdit() {
  try {
    const id = document.getElementById('editBrandId').value;
    const name = document.getElementById('editBrandName').value;
    const email = document.getElementById('editBrandEmail').value;
    const password = document.getElementById('editBrandPassword').value;
    
    if (!name || !email || !password) return alert('Заполните все поля');
    
    const res = await authorizedFetch(`${API}/brands/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password })
    });
    
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    alert('✅ Бренд обновлен');
    closeEditModal();
    loadBrands();
    populateBrandsForCampaign();
  } catch (error) {
    alert('Ошибка сохранения изменений: ' + error.message);
  }
}

function closeEditModal() {
  document.getElementById('editBrandModal').style.display = 'none';
  document.getElementById('editBrandId').value = '';
  document.getElementById('editBrandName').value = '';
  document.getElementById('editBrandEmail').value = '';
  document.getElementById('editBrandPassword').value = '';
}

async function deleteBrand(id) {
  if (!confirm('Удалить бренд?')) return;
  try {
    const res = await authorizedFetch(`${API}/brands/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    
    loadBrands(); 
    populateBrandsForCampaign();
  } catch (error) {
    alert('Ошибка удаления бренда: ' + error.message);
  }
}

// ===== SCREEN FUNCTIONS =====
async function loadScreens() {
  try {
  const res = await authorizedFetch(`${API}/screens`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
    
  const table = document.querySelector("#screensTable tbody");
  table.innerHTML = "";
    
    const screens = Array.isArray(data) ? data : [];
    screens.forEach(screen => {
      const row = document.createElement('tr');
      
      const screenIdCell = document.createElement('td');
      screenIdCell.textContent = screen.screenId || 'N/A';
      
      const brandIdCell = document.createElement('td');
      brandIdCell.textContent = screen.brandId || '-';
      
      const campaignIdCell = document.createElement('td');
      campaignIdCell.textContent = screen.currentCampaignId || '-';
      
      const statusCell = document.createElement('td');
      const isOnline = screen.isOnline !== false; // Default to true if not set
      const statusBadge = document.createElement('span');
      statusBadge.style.cssText = `
        padding: 4px 12px; 
        border-radius: 12px; 
        font-size: 0.85rem; 
        font-weight: 500; 
        ${isOnline ? 
          'background: linear-gradient(135deg, #59FF70, #38f9d7); color: #ffffff;' : 
          'background: linear-gradient(135deg, #FF7A45, #a83279); color: #ffffff;'
        }
      `;
      statusBadge.textContent = isOnline ? '🟢 Онлайн' : '🔴 Оффлайн';
      statusCell.appendChild(statusBadge);
      
      const actionsCell = document.createElement('td');
      
      const editBtn = createSafeElement('button', {
        class: 'btn-details',
        onclick: `editScreen('${escapeHtml(screen._id)}')`
      }, '✏️ Изменить');
      
      const toggleBtn = createSafeElement('button', {
        class: isOnline ? 'btn-danger' : 'btn-success',
        onclick: `toggleScreenOnline('${escapeHtml(screen._id)}')`
      }, isOnline ? '🔴 Выключить' : '🟢 Включить');
      
      const deleteBtn = createSafeElement('button', {
        class: 'btn-danger',
        onclick: `deleteScreen('${escapeHtml(screen._id)}')`
      }, '🗑 Удалить');
      
      actionsCell.appendChild(editBtn);
      actionsCell.appendChild(toggleBtn);
      actionsCell.appendChild(deleteBtn);
      
      row.appendChild(screenIdCell);
      row.appendChild(brandIdCell);
      row.appendChild(campaignIdCell);
      row.appendChild(statusCell);
      row.appendChild(actionsCell);
      
      table.appendChild(row);
  });
  } catch (error) {
    alert('Ошибка загрузки экранов: ' + error.message);
  }
}

async function createScreen() {
  try {
  const screenId = document.getElementById('screenId').value;
  const brandId = document.getElementById('screenBrandId').value;
  if (!screenId || !brandId) return alert('Введите оба значения');
    
    const res = await authorizedFetch(`${API}/screens`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ screenId, brandId })
  });
    
    //if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || `HTTP error ${res.status}`);
    }
  alert('✅ Экран создан');
    document.getElementById('screenId').value = '';
    document.getElementById('screenBrandId').value = '';
    loadScreens(); 
    populateScreens();
  } catch (error) {
    alert('Ошибка создания экрана: ' + error.message);
  }
}

async function editScreen(id) {
  try {
    const res = await authorizedFetch(`/api/screens/${id}`);
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    const screen = await res.json();
    document.getElementById('editScreenId').value = screen._id;
    document.getElementById('editScreenScreenId').value = screen.screenId || '';
    document.getElementById('editScreenBrandId').value = screen.brandId || '';
    document.getElementById('editScreenIsOnline').checked = screen.isOnline !== false; // Default to true
    document.getElementById('editScreenModal').style.display = 'block';
  } catch (error) {
    alert('Ошибка загрузки данных экрана: ' + error.message);
  }
}

async function saveScreenEdit() {
  try {
    const id = document.getElementById('editScreenId').value;
    const screenId = document.getElementById('editScreenScreenId').value;
    const brandId = document.getElementById('editScreenBrandId').value;
    const isOnline = document.getElementById('editScreenIsOnline').checked;
    if (!screenId || !brandId) return alert('Заполните все поля');
    
    const res = await authorizedFetch(`/api/admin/screens/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ screenId, brandId, isOnline })
    });
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    alert('✅ Экран обновлен');
    closeScreenEditModal();
    loadScreens();
    populateScreens();
  } catch (error) {
    alert('Ошибка сохранения изменений: ' + error.message);
  }
}

function closeScreenEditModal() {
  document.getElementById('editScreenModal').style.display = 'none';
  document.getElementById('editScreenId').value = '';
  document.getElementById('editScreenScreenId').value = '';
  document.getElementById('editScreenBrandId').value = '';
  document.getElementById('editScreenIsOnline').checked = true;
}

async function deleteScreen(id) {
  if (!confirm('Удалить экран?')) return;
  try {
    const res = await authorizedFetch(`/api/screens/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    alert('✅ Экран удалён');
    loadScreens();
    populateScreens();
  } catch (error) {
    alert('Ошибка удаления экрана: ' + error.message);
  }
}

// Toggle individual screen online status
async function toggleScreenOnline(id) {
  try {
    const res = await authorizedFetch(`${API}/screens/${id}/toggle-online`, {
      method: 'PATCH'
    });
    
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    const data = await res.json();
    alert('✅ ' + data.message);
    loadScreens();
  } catch (error) {
    alert('Ошибка изменения статуса экрана: ' + error.message);
  }
}

// Bulk toggle all screens
async function bulkToggleScreens(isOnline) {
  const action = isOnline ? 'включить' : 'выключить';
  if (!confirm(`Вы уверены, что хотите ${action} все экраны?`)) return;
  
  try {
    // First get all screens
    const screensRes = await authorizedFetch(`${API}/screens`);
    if (!screensRes.ok) throw new Error('Failed to fetch screens');
    
    const screens = await screensRes.json();
    if (!Array.isArray(screens) || screens.length === 0) {
      alert('Нет экранов для управления');
      return;
    }
    
    const screenIds = screens.map(screen => screen._id);
    
    const res = await authorizedFetch(`${API}/screens/bulk-toggle`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ screenIds, isOnline })
    });
    
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    const data = await res.json();
    alert('✅ ' + data.message);
    loadScreens();
  } catch (error) {
    alert('Ошибка массового изменения статуса: ' + error.message);
  }
}

// ===== CAMPAIGN FUNCTIONS =====
async function loadCampaignsList() {
  try {
    const res = await authorizedFetch(`${API}/campaigns`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
    
    const list = document.getElementById('campaignList');
    list.innerHTML = '';
    
    const campaigns = Array.isArray(data) ? data : [];
    campaigns.forEach(c => {
      const el = document.createElement('div');
      
      // Create safe text content
      const nameSpan = document.createElement('b');
      nameSpan.textContent = c.name || 'N/A';
      
      const idSpan = document.createElement('span');
      idSpan.textContent = ` (${c._id || 'N/A'})`;
      
      // Create buttons safely
      const editBtn = createSafeElement('button', {
        class: 'btn-details',
        onclick: `editCampaign('${escapeHtml(c._id)}')`
      }, '✏️ Изменить');
      
      const deleteBtn = createSafeElement('button', {
        class: 'btn-danger',
        onclick: `deleteCampaign('${escapeHtml(c._id)}')`
      }, '🗑 Удалить');
      
      const qrBtn = createSafeElement('button', {
        class: 'btn-main',
        onclick: `generateQRCode('${escapeHtml(c._id)}')`
      }, '📱 QR код');
      
      el.appendChild(nameSpan);
      el.appendChild(idSpan);
      el.appendChild(editBtn);
      el.appendChild(deleteBtn);
      el.appendChild(qrBtn);
      
      list.appendChild(el);
    });
  } catch (error) {
    alert('Ошибка загрузки кампаний: ' + error.message);
  }
}

async function createCampaign() {
  try {
    const name = document.getElementById('campaignName').value;
    const brandId = document.getElementById('campaignBrandSelect').value;
    const startDate = document.getElementById('campaignStart').value;
    const endDate = document.getElementById('campaignEnd').value;
    const videoLinks = document.getElementById('campaignVideos').value.split('\n').map(v => v.trim()).filter(Boolean);
    const promoUrl = document.getElementById('campaignPromoUrl').value;
    if (!name || !brandId || videoLinks.length === 0) return alert('Заполни название, бренд и видео');
    const res = await authorizedFetch(`${API}/campaigns`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, brandId, startDate, endDate, videos: videoLinks, promoUrl })
    });
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    alert('✅ Кампания создана');
    document.getElementById('campaignName').value = '';
    document.getElementById('campaignBrandSelect').value = '';
    document.getElementById('campaignStart').value = '';
    document.getElementById('campaignEnd').value = '';
    document.getElementById('campaignVideos').value = '';
    document.getElementById('campaignPromoUrl').value = '';
    loadCampaignsList();
  } catch (error) {
    alert('Ошибка создания кампании: ' + error.message);
  }
}

async function editCampaign(id) {
  try {
    const res = await authorizedFetch(`/api/admin/campaigns/${id}`);
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    const campaign = await res.json();
    document.getElementById('editCampaignId').value = campaign._id;
    document.getElementById('editCampaignName').value = campaign.name || '';
    document.getElementById('editCampaignStart').value = campaign.startDate ? campaign.startDate.substr(0,10) : '';
    document.getElementById('editCampaignEnd').value = campaign.endDate ? campaign.endDate.substr(0,10) : '';
    document.getElementById('editCampaignPromoUrl').value = campaign.promoUrl || '';
    document.getElementById('editCampaignVideos').value = Array.isArray(campaign.videos) ? campaign.videos.join('\n') : '';
    document.getElementById('editCampaignModal').style.display = 'block';
  } catch (error) {
    alert('Ошибка загрузки данных кампании: ' + error.message);
  }
}

async function saveCampaignEdit() {
  try {
    const id = document.getElementById('editCampaignId').value;
    const name = document.getElementById('editCampaignName').value;
    const startDate = document.getElementById('editCampaignStart').value;
    const endDate = document.getElementById('editCampaignEnd').value;
    const promoUrl = document.getElementById('editCampaignPromoUrl').value;
    const videos = document.getElementById('editCampaignVideos').value.split('\n').map(v => v.trim()).filter(Boolean);
    if (!name || videos.length === 0) return alert('Заполните название и видео');
    
    const res = await authorizedFetch(`/api/admin/campaigns/${id}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, startDate, endDate, promoUrl, videos })
    });
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    
    alert('✅ Кампания обновлена');
    closeCampaignEditModal();
    loadCampaignsList();
    populateCampaigns();
  } catch (error) {
    alert('Ошибка сохранения изменений: ' + error.message);
  }
}

function closeCampaignEditModal() {
  document.getElementById('editCampaignModal').style.display = 'none';
  document.getElementById('editCampaignId').value = '';
  document.getElementById('editCampaignName').value = '';
  document.getElementById('editCampaignStart').value = '';
  document.getElementById('editCampaignEnd').value = '';
  document.getElementById('editCampaignPromoUrl').value = '';
  document.getElementById('editCampaignVideos').value = '';
}

async function deleteCampaign(id) {
  if (!confirm('Удалить кампанию?')) return;
  try {
    const res = await authorizedFetch(`/api/admin/campaigns/${id}`, { method: 'DELETE' });
    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
    alert('✅ Кампания удалена');
    loadCampaignsList();
    populateCampaigns();
  } catch (error) {
    alert('Ошибка удаления кампании: ' + error.message);
  }
}

// ===== POPULATE FUNCTIONS =====
async function populateScreens() {
  try {
  const res = await authorizedFetch(`${API}/screens`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
  const select = document.getElementById('selectScreen');
    select.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Выберите экран';
    select.appendChild(defaultOption);
    
    const screens = Array.isArray(data) ? data : [];
    screens.forEach(s => {
    const option = document.createElement('option');
    option.value = s.screenId;
    option.textContent = s.screenId;
    select.appendChild(option);
  });
  } catch (error) {
    console.error('Error populating screens:', error);
  }
}

async function populateCampaigns() {
  try {
  const res = await authorizedFetch(`${API}/campaigns`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
  const data = await res.json();
  const select = document.getElementById('selectCampaign');
    select.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Выберите кампанию';
    select.appendChild(defaultOption);
    
    const campaigns = Array.isArray(data) ? data : [];
    campaigns.forEach(c => {
    const option = document.createElement('option');
    option.value = c._id;
    option.textContent = c.name;
    select.appendChild(option);
  });
  } catch (error) {
    console.error('Error populating campaigns:', error);
  }
}

// ===== ASSIGNMENT FUNCTIONS =====
async function assignCampaign() {
  try {
  const screenId = document.getElementById('selectScreen').value;
  const campaignId = document.getElementById('selectCampaign').value;
  if (!screenId || !campaignId) return alert('Выбери оба поля');
    
    const res = await authorizedFetch(`${API.replace('/admin','')}/screens/assign-campaign`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ screenId, campaignId })
  });
    
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    
  alert('✅ Кампания назначена');
  loadScreens();
  } catch (error) {
    alert('Ошибка назначения кампании: ' + error.message);
  }
}

// ===== STATS FUNCTIONS =====
async function loadStats() {
  const res = await authorizedFetch(`${API}/stats/summary`);
  if (!res.ok) return alert('Ошибка загрузки статистики');
  const data = await res.json();
  const div = document.getElementById('statsSummary');

  let detailedHtml = '';
  
  if (data.detailedByBrand && data.detailedByBrand.length > 0) {
    detailedHtml = '<h4>Детальная статистика по брендам:</h4>';
    data.detailedByBrand.forEach(brand => {
      detailedHtml += `<div style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 5px; display: flex; align-items: center; min-height: 100px;">`;
      detailedHtml += `<div style="flex: 1;">`;
      detailedHtml += `<h5 style="margin: 0 0 10px 0; color: #c9b5ff; font-size: 18px; font-weight: 700; padding-left: 5px;">${brand.name}</h5>`;
      
      if (brand.screens && brand.screens.length > 0) {
        brand.screens.forEach(screen => {
          detailedHtml += `<div style="margin: 5px 0; padding: 5px; background: #linear-gradient(135deg, #181c2f 0%, #2a225a 50%, #3a1c71 100%); border-radius: 3px;">`;
          detailedHtml += `<strong>Экран:</strong> ${screen.screenId} | `;
          detailedHtml += `<strong>Кампания:</strong> ${screen.campaignName} | `;
          detailedHtml += `<strong>Показы:</strong> ${screen.impressions} | `;
          detailedHtml += `<strong>Клики:</strong> ${screen.clicks}`;
          detailedHtml += `</div>`;
        });
      } else {
        detailedHtml += `<p style="color: #666; font-style: italic;">Нет данных по экранам</p>`;
      }
      detailedHtml += `</div>`;
      
      detailedHtml += `<div style="display: flex; align-items: center; margin-left: 20px;">`;
      // Fix: Escape single quotes in brand.name for JS string
      const safeBrandName = brand.name.replace(/'/g, "\\'");
      detailedHtml += `<button onclick="openBrandChart('${brand.brandId}', '${safeBrandName}')" class="btn btn-success">📊 Подробнее</button>`;
      detailedHtml += `</div>`;
      detailedHtml += `</div>`;
    });
  }

  div.innerHTML = '';
  
  const totalImpressions = document.createElement('p');
  totalImpressions.innerHTML = `<b>Всего показов:</b> ${escapeHtml(data.total.impressions)}`;
  
  const totalClicks = document.createElement('p');
  totalClicks.innerHTML = `<b>Всего кликов:</b> ${escapeHtml(data.total.clicks)}`;
  
  div.appendChild(totalImpressions);
  div.appendChild(totalClicks);
  
  // Add detailed HTML safely
  if (detailedHtml) {
    const detailedDiv = document.createElement('div');
    detailedDiv.innerHTML = detailedHtml;
    div.appendChild(detailedDiv);
  }
}


// ===== CHART FUNCTIONS =====
let brandChart = null;
let currentBrandId = null;

async function openBrandChart(brandId, brandName) {
  currentBrandId = brandId;
  document.getElementById('chartBrandName').textContent = brandName;
  document.getElementById('brandChartModal').style.display = 'block';
  await loadBrandChart();
}

async function loadBrandChart() {
  if (!currentBrandId) return;
  
  const period = document.getElementById('chartPeriod').value;
  
  try {
    const res = await authorizedFetch(`${API}/stats/brand/${currentBrandId}?days=${period}`);
    if (!res.ok) throw new Error('Ошибка загрузки данных');
    
    const data = await res.json();
    
    // Destroy existing chart
    if (brandChart) {
      brandChart.destroy();
    }
    
    // Create new chart
    const ctx = document.getElementById('brandChart').getContext('2d');
    brandChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          {
            label: 'Показы',
            data: data.impressions,
            borderColor: 'rgb(75, 192, 192)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.1
          },
          {
            label: 'Клики',
            data: data.clicks,
            borderColor: 'rgb(255, 99, 132)',
            backgroundColor: 'rgba(255, 99, 132, 0.2)',
            tension: 0.1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Статистика по дням',
            color: '#c9b5ff'
          }
        },
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
    
    // Update details section
    updateChartDetails(data);
    
  } catch (error) {
    console.error('Chart error:', error);
    alert('Ошибка загрузки графика: ' + error.message);
  }
}

function updateChartDetails(data) {
  const detailsDiv = document.getElementById('brandChartDetails');
  
  let detailsHtml = '<h3 style="margin: 0 0 20px 0; color: #c9b5ff; border-bottom: 2px solid #007bff; padding-bottom: 10px;">📈 Основные показатели</h3>';
  
  if (data.hasAllTimeData) {
    detailsHtml += '<div style="background: #0f0e19; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin-bottom: 20px; color: #c9b5ff;">⚠️ Показаны данные за все время (нет данных за выбранный период)</div>';
  }
  
  detailsHtml += `
    <div style="background: #0f0e19; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">Показы:</span>
        <span style="font-size: 18px; font-weight: bold; color: #007bff;">${data.totalImpressions}</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">Клики:</span>
        <span style="font-size: 18px; font-weight: bold; color: #28a745;">${data.totalClicks}</span>
      </div>
      <div style="display: flex; justify-content: space-between; border-top: 1px solid #eee; padding-top: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">CTR:</span>
        <span style="font-size: 18px; font-weight: bold; color: #ffc107;">${data.ctr}%</span>
      </div>
    </div>
  `;
  
  if (data.topScreens && data.topScreens.length > 0) {
    detailsHtml += '<h4 style="margin: 20px 0 15px 0; color: #c9b5ff;">🖥️ Топ экранов</h4>';
    detailsHtml += '<div style="background: #0f0e19; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
    data.topScreens.forEach((screen, index) => {
      detailsHtml += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; ${index > 0 ? 'border-top: 1px solid #333;' : ''}">
          <div style="font-weight: 500; color: #c9b5ff; max-width: 60%; word-break: break-word;">${screen.screenName || screen.screenId || 'Неизвестный экран'}</div>
          <div style="text-align: right; min-width: 120px;">
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${screen.impressions} показов</span>
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${screen.clicks} кликов</span>
          </div>
        </div>
      `;
    });
    detailsHtml += '</div>';
  }
  
  if (data.topCampaigns && data.topCampaigns.length > 0) {
    detailsHtml += '<h4 style="margin: 20px 0 15px 0; color: #c9b5ff;">🎯 Топ кампаний</h4>';
    detailsHtml += '<div style="background: #0f0e19; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
    data.topCampaigns.forEach((campaign, index) => {
      detailsHtml += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; ${index > 0 ? 'border-top: 1px solid #333;' : ''}">
          <div style="font-weight: 500; color: #c9b5ff; max-width: 60%; word-break: break-word;">${campaign.name}</div>
          <div style="text-align: right; min-width: 120px;">
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${campaign.impressions} показов</span>
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${campaign.clicks} кликов</span>
          </div>
        </div>
      `;
    });
    detailsHtml += '</div>';
  }
  
  detailsDiv.innerHTML = detailsHtml;
}

function closeBrandChartModal() {
  document.getElementById('brandChartModal').style.display = 'none';
  if (brandChart) {
    brandChart.destroy();
    brandChart = null;
  }
  currentBrandId = null;
}

// ===== ENVIRONMENT DETECTION =====
// Browser-compatible environment detection
const isProduction = window.location.hostname !== 'localhost' && 
                    window.location.hostname !== '127.0.0.1' && 
                    !window.location.hostname.includes('dev') &&
                    !window.location.hostname.includes('test');

// ===== QR CODE FUNCTIONS =====
async function generateQRCode(campaignId) {
  try {
    // Debug logging (only in development)
    if (!isProduction) {
      console.log('Generating QR code for campaign:', campaignId);
    }
    // First get campaign info to find screens
    const campaignRes = await authorizedFetch(`${API}/campaigns/${campaignId}`);
    if (!campaignRes.ok) throw new Error('Failed to get campaign');
    const campaign = await campaignRes.json();
    
    // Get all screens assigned to this specific campaign
    const screensRes = await authorizedFetch(`${API}/screens`);
    if (!screensRes.ok) throw new Error('Failed to get screens');
    const screens = await screensRes.json();
    
    // Filter screens that are specifically assigned to this campaign
    const campaignScreens = screens.filter(s => s.currentCampaignId === campaignId);
    
    if (campaignScreens.length === 0) {
      alert(`Нет экранов, назначенных на кампанию "${campaign.name}".\n\nДля создания QR кода:\n1. Создайте экран для бренда\n2. Назначьте экран на эту кампанию в разделе "Привязка кампании к экрану"`);
      return;
    }
    
    // Check if there are any online screens
    const onlineScreens = campaignScreens.filter(s => s.isOnline !== false);
    if (onlineScreens.length === 0) {
      alert(`Все экраны кампании "${campaign.name}" сейчас выключены.\n\nВключите хотя бы один экран для создания QR кода.`);
      return;
    }
    
    // Create screen selection modal for multiple screens
    // Prioritize online screens for single selection
    let selectedScreen = onlineScreens.length > 0 ? onlineScreens[0] : campaignScreens[0];
    
    if (campaignScreens.length > 1) {
      // Create screen selection modal
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
      `;
      
      modal.innerHTML = '';
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = 'background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%;';
      modalContent.classList.add('qr-modal');
      
      const title = document.createElement('h3');
      title.textContent = 'Выберите экран для QR кода';
      
      const onlineScreens = campaignScreens.filter(s => s.isOnline !== false);
      const description = document.createElement('p');
      description.style.cssText = 'color: #666; margin-bottom: 20px;';
      description.innerHTML = `Выберите экран из назначенных на кампанию "<strong>${escapeHtml(campaign.name)}</strong>":<br>
        <small>Доступно экранов: ${onlineScreens.length} из ${campaignScreens.length}</small>`;
      
      const screensContainer = document.createElement('div');
      screensContainer.style.cssText = 'margin-bottom: 20px;';
      
      campaignScreens.forEach(screen => {
        const isOnline = screen.isOnline !== false;
        const screenDiv = document.createElement('div');
        screenDiv.style.cssText = `
          margin: 10px 0; 
          padding: 10px; 
          border: 1px solid ${isOnline ? '#ddd' : '#dc3545'}; 
          border-radius: 5px; 
          cursor: ${isOnline ? 'pointer' : 'not-allowed'};
          background: ${isOnline ? '#ffffff' : '#f8f9fa'};
          opacity: ${isOnline ? '1' : '0.6'};
        `;
        
        if (isOnline) {
          screenDiv.onclick = () => selectScreenForQR(escapeHtml(screen.screenId), escapeHtml(campaignId), modal);
        } else {
          screenDiv.onclick = () => alert('Нельзя создать QR код для выключенного экрана. Сначала включите экран.');
        }
        
        const screenText = document.createElement('strong');
        screenText.textContent = 'Экран: ';
        
        const screenIdSpan = document.createElement('span');
        screenIdSpan.textContent = screen.screenId;
        
        screenDiv.appendChild(screenText);
        screenDiv.appendChild(screenIdSpan);
        
        // Add campaign assignment info
        const campaignInfo = document.createElement('br');
        const campaignSmall = document.createElement('small');
        campaignSmall.style.cssText = 'color: #28a745; font-weight: 500;';
        campaignSmall.textContent = `✅ Назначен на эту кампанию`;
        screenDiv.appendChild(campaignInfo);
        screenDiv.appendChild(campaignSmall);
        
        // Add online status indicator
        const onlineStatus = document.createElement('br');
        const statusSmall = document.createElement('small');
        statusSmall.style.cssText = screen.isOnline !== false ? 'color: #28a745;' : 'color: #dc3545;';
        statusSmall.textContent = screen.isOnline !== false ? '🟢 Онлайн' : '🔴 Оффлайн';
        screenDiv.appendChild(onlineStatus);
        screenDiv.appendChild(statusSmall);
        
        screensContainer.appendChild(screenDiv);
      });
      
      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'btn btn-danger';
      cancelBtn.textContent = 'Отмена';
      cancelBtn.onclick = () => modal.remove();
      
      modalContent.appendChild(title);
      modalContent.appendChild(description);
      modalContent.appendChild(screensContainer);
      modalContent.appendChild(cancelBtn);
      
      modal.appendChild(modalContent);
      
      document.body.appendChild(modal);
      return; // Exit here, let the modal handle the selection
    }
    
    // Check if the single screen is online
    if (selectedScreen.isOnline === false) {
      alert('Нельзя создать QR код для выключенного экрана. Сначала включите экран в панели управления.');
      return;
    }
    
    if (!isProduction) {
      console.log('Using screen for QR:', selectedScreen.screenId);
    }
    
    // Generate QR code for single screen
    await generateQRForScreen(selectedScreen.screenId, campaignId);
  } catch (error) {
    console.error('QR code generation error:', error);
    alert('Ошибка генерации QR кода: ' + error.message);
  }
}

async function selectScreenForQR(screenId, campaignId, modalElement) {
  try {
    if (!isProduction) {
      console.log('Generating QR code for screen:', screenId, 'campaign:', campaignId);
    }
    
    // Remove the selection modal
    modalElement.remove();
    
    // Generate QR code for selected screen
    await generateQRForScreen(screenId, campaignId);
    
  } catch (error) {
    console.error('QR code generation error:', error);
    alert('Ошибка генерации QR кода: ' + error.message);
  }
}

async function generateQRForScreen(screenId, campaignId) {
  try {
    if (!isProduction) {
      console.log('Starting QR generation for screen:', screenId, 'campaign:', campaignId);
    }
    
    // Ensure DOM is ready
    if (document.readyState !== 'complete' && document.readyState !== 'interactive') {
      if (!isProduction) {
      console.log('DOM not ready, waiting...');
    }
      await new Promise(resolve => {
        document.addEventListener('DOMContentLoaded', resolve, { once: true });
      });
    }
    
    // Use authorizedFetch but with error handling for extension interference
    if (!isProduction) {
      console.log('Making API call to:', `${API}/tracking/qr/${campaignId}?screenId=${screenId}`);
    }
    const res = await authorizedFetch(`${API}/tracking/qr/${campaignId}?screenId=${screenId}`);
    
    if (!isProduction) {
      console.log('Response status:', res.status);
    }
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('Server error:', errorText);
      throw new Error(`HTTP ${res.status}: ${errorText}`);
    }
    
    const data = await res.json();
    if (!isProduction) {
      console.log('QR data received:', data);
    }
    
    // Validate data structure
    if (!data || !data.qrData || !data.qrData.url || !data.qrData.params) {
      console.error('Invalid QR data structure:', data);
      throw new Error('Invalid QR data structure received from server');
    }
    
    // Create QR code container
    const qrContainer = document.createElement('div');
    qrContainer.style.cssText = `
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      z-index: 2000;
      text-align: center;
      max-width: 90vw;
      max-height: 90vh;
      overflow: auto;
    `;
    
    const uniqueId = 'qrcode_' + Date.now();
    qrContainer.innerHTML = '';
    
    const title = document.createElement('h3');
    title.textContent = `QR код для экрана: ${escapeHtml(screenId)}`;
    
    const qrDiv = document.createElement('div');
    qrDiv.id = uniqueId;
    qrDiv.style.cssText = 'margin: 20px 0;';
    
    const trackingIdP = document.createElement('p');
    trackingIdP.style.cssText = 'margin-top: 15px; font-size: 12px; color: #666;';
    trackingIdP.textContent = `Tracking ID: ${escapeHtml(data.trackingId)}`;
    
    const urlP = document.createElement('p');
    urlP.style.cssText = 'font-size: 11px; color: #999; margin-top: 10px;';
    urlP.textContent = `URL: ${escapeHtml(new URL(data.qrData.url, window.location.origin).toString())}`;
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'btn btn-danger';
    closeBtn.style.cssText = 'margin-top: 15px;';
    closeBtn.textContent = 'Закрыть';
    closeBtn.onclick = () => {
      qrContainer.remove();
      location.reload();
    };
    
    qrContainer.appendChild(title);
    qrContainer.appendChild(qrDiv);
    qrContainer.appendChild(trackingIdP);
    qrContainer.appendChild(urlP);
    qrContainer.appendChild(closeBtn);
    
    // Add QR modal class for proper styling
    qrContainer.classList.add('qr-modal');
    
    // Ensure document.body exists before appending
    let container = document.body;
    if (!container) {
      // Try to append to the first available container
      container = document.querySelector('body') || document.documentElement || document;
      if (!container || !container.appendChild) {
        throw new Error('No suitable container found for QR code');
      }
    }
    container.appendChild(qrContainer);
    
    // Generate QR code with error handling
    try {
      const qrElement = document.getElementById(uniqueId);
      if (qrElement) {
        // Check if QRCode library is available
        if (typeof QRCode !== 'undefined') {
          // Build the actual URL with parameters
          const url = new URL(data.qrData.url, window.location.origin);
          Object.keys(data.qrData.params).forEach(key => {
            url.searchParams.set(key, data.qrData.params[key]);
          });
          
          new QRCode(qrElement, {
            text: url.toString(),
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
          });
        } else {
          // Fallback: use simple QR generation
          if (!isProduction) {
      console.log('Using fallback QR generation');
    }
          const url = new URL(data.qrData.url, window.location.origin);
          Object.keys(data.qrData.params).forEach(key => {
            url.searchParams.set(key, data.qrData.params[key]);
          });
          window.generateSimpleQR(url.toString(), uniqueId);
        }
      } else {
        throw new Error('QR element not found');
      }
    } catch (qrError) {
      console.error('QR generation error:', qrError);
      const errorElement = document.getElementById(uniqueId);
      if (errorElement) {
        errorElement.innerHTML = '';
        
        const errorDiv = document.createElement('div');
        errorDiv.style.cssText = 'color: #666; padding: 20px; background: #f9f9f9; border-radius: 8px; font-family: monospace; font-size: 12px;';
        
        const errorTitle = document.createElement('h4');
        errorTitle.textContent = 'QR Code Data (Library not available)';
        
        const urlP = document.createElement('p');
        urlP.innerHTML = `<strong>URL:</strong> ${escapeHtml(data.qrData.url)}`;
        
        const screenP = document.createElement('p');
        screenP.innerHTML = `<strong>Screen:</strong> ${escapeHtml(screenId)}`;
        
        const dataP = document.createElement('p');
        dataP.innerHTML = '<strong>Data:</strong>';
        
        const dataPre = document.createElement('pre');
        dataPre.style.cssText = 'background: white; padding: 10px; border-radius: 4px; overflow-x: auto;';
        dataPre.textContent = JSON.stringify(data.qrData.params, null, 2);
        
        errorDiv.appendChild(errorTitle);
        errorDiv.appendChild(urlP);
        errorDiv.appendChild(screenP);
        errorDiv.appendChild(dataP);
        errorDiv.appendChild(dataPre);
        
        errorElement.appendChild(errorDiv);
      }
    }
    
  } catch (error) {
    console.error('QR code generation error:', error);
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      screenId: screenId,
      campaignId: campaignId
    });
    alert('Ошибка генерации QR кода: ' + (error.message || 'Неизвестная ошибка'));
  }
}

// ===== POPULATE FUNCTIONS =====
async function populateBrandsForCampaign() {
  try {
    const res = await authorizedFetch(`${API}/brands`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const data = await res.json();
    const select = document.getElementById('campaignBrandSelect');
    select.innerHTML = '';
    const defaultOption = document.createElement('option');
    defaultOption.value = '';
    defaultOption.textContent = 'Выберите бренд';
    select.appendChild(defaultOption);
    const brands = Array.isArray(data) ? data : [];
    brands.forEach(b => {
      const option = document.createElement('option');
      option.value = b._id;
      option.textContent = b.name;
      select.appendChild(option);
    });
  } catch (error) {
    console.error('Error populating brands for campaign:', error);
  }
}

async function populateScreens() {
  try {
    const res = await authorizedFetch(`${API}/screens`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const screens = await res.json();
    
    const selectScreen = document.getElementById('selectScreen');
    if (selectScreen) {
      selectScreen.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Выберите экран';
      selectScreen.appendChild(defaultOption);
      
      screens.forEach(screen => {
        const option = document.createElement('option');
        option.value = escapeHtml(screen.screenId);
        option.textContent = screen.screenId;
        selectScreen.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Error populating screens:', error);
  }
}

async function populateCampaigns() {
  try {
    const res = await authorizedFetch(`${API}/campaigns`);
    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
    const campaigns = await res.json();
    
    const selectCampaign = document.getElementById('selectCampaign');
    if (selectCampaign) {
      selectCampaign.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Выберите кампанию';
      selectCampaign.appendChild(defaultOption);
      
      campaigns.forEach(campaign => {
        const option = document.createElement('option');
        option.value = escapeHtml(campaign._id);
        option.textContent = campaign.name;
        selectCampaign.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Error populating campaigns:', error);
  }
}

// ===== CLEAR STATISTICS FUNCTIONS =====
function showClearStatsModal() {
  document.getElementById('clearStatsModal').style.display = 'block';
  populateClearStatsDropdowns();
}

function closeClearStatsModal() {
  document.getElementById('clearStatsModal').style.display = 'none';
}

async function populateClearStatsDropdowns() {
  try {
    // Populate brands dropdown
    const brandsRes = await authorizedFetch(`${API}/brands`);
    if (brandsRes.ok) {
      const brands = await brandsRes.json();
      const brandSelect = document.getElementById('clearBrandSelect');
      brandSelect.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Выберите бренд...';
      brandSelect.appendChild(defaultOption);
      
      brands.forEach(brand => {
        const option = document.createElement('option');
        option.value = escapeHtml(brand._id);
        option.textContent = brand.name;
        brandSelect.appendChild(option);
      });
    }

    // Populate campaigns dropdown
    const campaignsRes = await authorizedFetch(`${API}/campaigns`);
    if (campaignsRes.ok) {
      const campaigns = await campaignsRes.json();
      const campaignSelect = document.getElementById('clearCampaignSelect');
      campaignSelect.innerHTML = '';
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Выберите кампанию...';
      campaignSelect.appendChild(defaultOption);
      
      campaigns.forEach(campaign => {
        const option = document.createElement('option');
        option.value = escapeHtml(campaign._id);
        option.textContent = campaign.name;
        campaignSelect.appendChild(option);
      });
    }
  } catch (error) {
    console.error('Error populating clear stats dropdowns:', error);
  }
}

// Handle radio button changes
document.addEventListener('change', function(e) {
  if (e.target.name === 'clearType') {
    const brandSelect = document.getElementById('clearBrandSelect');
    const campaignSelect = document.getElementById('clearCampaignSelect');
    
    if (e.target.value === 'brand') {
      brandSelect.style.display = 'inline-block';
      campaignSelect.style.display = 'none';
    } else if (e.target.value === 'campaign') {
      brandSelect.style.display = 'none';
      campaignSelect.style.display = 'inline-block';
    } else {
      brandSelect.style.display = 'none';
      campaignSelect.style.display = 'none';
    }
  }
});

async function clearStats() {
  const clearType = document.querySelector('input[name="clearType"]:checked').value;
  let targetId = '';
  let targetName = '';

  if (clearType === 'brand') {
    targetId = document.getElementById('clearBrandSelect').value;
    if (!targetId) {
      alert('Пожалуйста, выберите бренд');
      return;
    }
    targetName = document.getElementById('clearBrandSelect').options[document.getElementById('clearBrandSelect').selectedIndex].text;
  } else if (clearType === 'campaign') {
    targetId = document.getElementById('clearCampaignSelect').value;
    if (!targetId) {
      alert('Пожалуйста, выберите кампанию');
      return;
    }
    targetName = document.getElementById('clearCampaignSelect').options[document.getElementById('clearCampaignSelect').selectedIndex].text;
  }

  const confirmMessage = clearType === 'all' 
    ? 'Вы уверены, что хотите очистить ВСЮ статистику? Это действие нельзя отменить.'
    : `Вы уверены, что хотите очистить статистику для "${targetName}"? Это действие нельзя отменить.`;

  if (!confirm(confirmMessage)) {
    return;
  }

  try {
    let url = `${API}/stats`;
    if (clearType === 'brand') {
      url += `/brand/${targetId}`;
    } else if (clearType === 'campaign') {
      url += `/campaign/${targetId}`;
    }

    const response = await authorizedFetch(url, {
      method: 'DELETE'
    });

    if (response.ok) {
      const result = await response.json();
      alert(`✅ Статистика успешно очищена!\n\n${result.message || 'Удалено записей: ' + (result.deletedCount || 0)}`);
      closeClearStatsModal();
      loadStats(); // Refresh stats display
    } else {
      const error = await response.json();
      alert('❌ Ошибка при очистке статистики: ' + (error.error || 'Неизвестная ошибка'));
    }
  } catch (error) {
    console.error('Error clearing stats:', error);
    alert('❌ Ошибка при очистке статистики: ' + error.message);
  }
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', function() {
  loadBrands();
  loadScreens();
  populateScreens();
  populateCampaigns();
  loadCampaignsList();
  loadStats();
  populateBrandsForCampaign(); // <-- Ensure this is called after DOM is ready
});
</script>

</body>
</html>
