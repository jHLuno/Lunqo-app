<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Панель бренда - Lunqo Digital Out-of-Home Advertising Platform</title>
  <meta name="description" content="Панель управления брендом в Lunqo. Создавайте и управляйте рекламными кампаниями, отслеживайте статистику и контролируйте ваши экраны.">
  <meta name="keywords" content="панель бренда, рекламные кампании, digital advertising, out-of-home advertising, DOOH, smart screens, brand campaigns, advertising platform, Lunqo">
  <meta name="author" content="Lunqo">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">
  <!-- Favicons -->
  <link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
  <link rel="icon" href="/favicons/favicon.ico">
  <!-- Font Preloading for Performance -->
  <link rel="preload" href="/fonts/SF-Pro-Display-Regular.otf" as="font" type="font/otf" crossorigin>
  <link rel="preload" href="/fonts/SF-Pro-Display-Medium.otf" as="font" type="font/otf" crossorigin>
  <link rel="preload" href="/fonts/SF-Pro-Display-Bold.otf" as="font" type="font/otf" crossorigin>
  <link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
      font-display: block;
    }
    
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Medium.otf') format('opentype');
      font-weight: 500;
      font-style: normal;
      font-display: block;
    }
    
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Bold.otf') format('opentype');
      font-weight: 700;
      font-style: normal;
      font-display: block;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: linear-gradient(135deg, #050505 0%, #0a0a0a 25%, #0d1117 50%, #161b22 75%, #1a1a2e 100%);
      color: #ffffff;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    .main-wrapper {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
      position: relative;
    }
    
    /* Background Effects */
    .main-wrapper::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 25% 25%, rgba(24, 160, 251, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(89, 255, 112, 0.05) 0%, transparent 50%);
      background-size: 100px 100px, 150px 150px;
      opacity: 0.3;
      z-index: -1;
    }
    
    /* Floating Elements */
    .floating-element {
      position: fixed;
      border-radius: 8px;
      opacity: 0.05;
      animation: float 8s ease-in-out infinite;
      z-index: -1;
    }
    
    .floating-element:nth-child(1) {
      top: 20%;
      left: 8%;
      width: 50px;
      height: 35px;
      background: linear-gradient(135deg, rgba(24, 160, 251, 0.2), rgba(89, 255, 112, 0.2));
      border: 1px solid rgba(24, 160, 251, 0.3);
      animation-delay: 0s;
    }
    
    .floating-element:nth-child(2) {
      top: 65%;
      right: 8%;
      width: 35px;
      height: 25px;
      background: linear-gradient(135deg, rgba(89, 255, 112, 0.2), rgba(255, 122, 69, 0.2));
      border: 1px solid rgba(89, 255, 112, 0.3);
      animation-delay: 4s;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-12px) rotate(2deg); }
    }
    
    /* Enhanced table styling */
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 24px;
      background: rgba(33, 37, 41, 0.8);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
    }
    
    table:hover {
      box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
    }
    
    h1, h2, h3, h4 {
      font-weight: 700;
      color: #ffffff;
      margin-bottom: 16px;
      letter-spacing: -0.02em;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-top: 0;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #18A0FB, #59FF70);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    h2 {
      font-size: 1.8rem;
      margin-top: 48px;
      margin-bottom: 24px;
      color: #dee2e6;
    }
    
    .section-card {
      background: rgba(33, 37, 41, 0.5);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(52, 58, 64, 0.5);
      border-radius: 24px;
      padding: 40px;
      margin: 40px auto 0 auto;
      max-width: 1200px;
      width: 100%;
      position: relative;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.3),
        0 0 20px rgba(24, 160, 251, 0.1);
      transition: all 0.3s ease;
    }
    
    .section-card:hover {
      border-color: rgba(24, 160, 251, 0.3);
      box-shadow: 
        0 12px 40px rgba(0, 0, 0, 0.4),
        0 0 30px rgba(24, 160, 251, 0.2);
    }
    
    table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      margin-top: 24px;
      background: rgba(33, 37, 41, 0.8);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }
    
    th, td {
      padding: 20px 16px;
      border-bottom: 1px solid rgba(52, 58, 64, 0.5);
      text-align: left;
    }
    
    th {
      background: rgba(24, 160, 251, 0.1);
      color: #18A0FB;
      font-weight: 600;
      font-size: 1rem;
      letter-spacing: 0.01em;
      border-bottom: 2px solid rgba(24, 160, 251, 0.3);
    }
    
    tr:last-child td {
      border-bottom: none;
    }
    
    tr:hover {
      background: rgba(24, 160, 251, 0.05);
    }
    
    button {
      padding: 12px 24px;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif; 
      cursor: pointer;
      margin: 8px 8px 8px 0;
      transition: all 0.3s ease;
      outline: none;
    }
    
    .btn-logout {
      background: linear-gradient(135deg, #FF7A45, #a83279);
      color: #ffffff;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 24px;
      margin-top: 0;
      float: right;
      box-shadow: 0 4px 20px rgba(255, 122, 69, 0.3);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }
    
    .btn-logout:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 25px rgba(255, 122, 69, 0.3);
    }

    .btn, .btn-main {
      background: linear-gradient(135deg, #1565C0, #2E7D32);
      color: #ffffff;
      font-size: 1rem;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(24, 160, 251, 0.4);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .btn-success {
      background: linear-gradient(135deg, #2E7D32, #00695C);
      color: #ffffff;
      box-shadow: 0 4px 20px rgba(89, 255, 112, 0.4);
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    .btn-danger {
      background: linear-gradient(135deg, #FF7A45, #a83279) !important;
      color: #ffffff !important;
      box-shadow: 0 4px 20px rgba(255, 122, 69, 0.3) !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2) !important;
    }

    .btn:hover, .btn-main:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 25px rgba(24, 160, 251, 0.5);
      background: linear-gradient(135deg, #1976D2, #388E3C);
    }

    .btn-success:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 6px 25px rgba(89, 255, 112, 0.5);
      background: linear-gradient(135deg, #388E3C, #00796B);
    }

    .btn-danger:hover {
      box-shadow: 0 6px 25px rgba(255, 122, 69, 0.3);
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
    }

    .modal-content {
      background: rgba(33, 37, 41, 0.95);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(52, 58, 64, 0.5);
      margin: 3% auto;
      padding: 40px 32px 32px 32px;
      border-radius: 24px !important;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.4),
        0 0 20px rgba(24, 160, 251, 0.2);
      max-width: 440px;
      width: 97%;
      color: #ffffff;
    }
    
    a {
      color: #18A0FB;
      text-decoration: none;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    a:hover {
      color: #59FF70;
      text-shadow: 0 0 10px rgba(89, 255, 112, 0.5);
    }
    
    /* Status indicators */
    .status-active {
      color: #59FF70;
      font-weight: 600;
    }
    
    .status-inactive {
      color: #6c757d;
    }

    /* Custom Icon Classes */
    .icon {
      display: inline-block;
      width: 20px;
      height: 20px;
      margin-right: 8px;
      vertical-align: middle;
      background-size: contain;
      background-repeat: no-repeat;
      background-position: center;
    }

    .icon-stats {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2318A0FB' viewBox='0 0 24 24'%3E%3Cpath d='M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z'/%3E%3C/svg%3E");
    }

    .icon-chart {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2359FF70' viewBox='0 0 24 24'%3E%3Cpath d='M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z'/%3E%3C/svg%3E");
    }

    .icon-refresh {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ffffff' viewBox='0 0 24 24'%3E%3Cpath d='M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z'/%3E%3C/svg%3E");
    }

    .icon-eye {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2318A0FB' viewBox='0 0 24 24'%3E%3Cpath d='M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z'/%3E%3C/svg%3E");
    }

    .icon-click {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2359FF70' viewBox='0 0 24 24'%3E%3Cpath d='M9 11H7l.5-2h1.1l.4 2zm3 0h-2l-.4-2h2.4l.4 2zm3 0h-2l-.4-2H14l.5 2zm2.5 0h-1.1l-.4-2h1.1l.4 2zM19 7h-3V6a3 3 0 0 0-6 0v1H7a1 1 0 0 0-1 1v11a3 3 0 0 0 3 3h8a3 3 0 0 0 3-3V8a1 1 0 0 0-1-1zM12 4a1 1 0 0 1 1 1v1h-2V5a1 1 0 0 1 1-1zm5 15a1 1 0 0 1-1 1H8a1 1 0 0 1-1-1V9h10v10z'/%3E%3C/svg%3E");
    }

    /* Button-specific icon overrides for better visibility */
    .btn-success .icon-refresh {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ffffff' viewBox='0 0 24 24'%3E%3Cpath d='M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z'/%3E%3C/svg%3E");
    }

    .btn-main .icon-chart {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ffffff' viewBox='0 0 24 24'%3E%3Cpath d='M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z'/%3E%3C/svg%3E");
    }

    .icon-percentage {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23FF7A45' viewBox='0 0 24 24'%3E%3Cpath d='M7.5 11C8.33 11 9 10.33 9 9.5S8.33 8 7.5 8 6 8.67 6 9.5 6.67 11 7.5 11zm0-2C7.78 9 8 9.22 8 9.5S7.78 10 7.5 10 7 9.78 7 9.5 7.22 9 7.5 9zM16.5 13c-.83 0-1.5.67-1.5 1.5s.67 1.5 1.5 1.5 1.5-.67 1.5-1.5-.67-1.5-1.5-1.5zm0 2c-.28 0-.5-.22-.5-.5s.22-.5.5-.5.5.22.5.5-.22.5-.5.5zM18.42 6.22L17.58 5.38 5.38 17.58l.84.84L18.42 6.22z'/%3E%3C/svg%3E");
    }

    .icon-mobile {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23c9b5ff' viewBox='0 0 24 24'%3E%3Cpath d='M17 2H7c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM7 4h10v12H7V4z'/%3E%3C/svg%3E");
    }

    .icon-target {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23c9b5ff' viewBox='0 0 24 24'%3E%3Cpath d='M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm0-14c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm0 10c-2.21 0-4-1.79-4-4s1.79-4 4-4 4 1.79 4 4-1.79 4-4 4zm0-6c-1.1 0-2 .9-2 2s.9 2 2 2 2-.9 2-2-.9-2-2-2z'/%3E%3C/svg%3E");
    }

    .icon-calendar {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23c9b5ff' viewBox='0 0 24 24'%3E%3Cpath d='M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z'/%3E%3C/svg%3E");
    }

    .icon-video {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23FF7A45' viewBox='0 0 24 24'%3E%3Cpath d='M8 5v14l11-7z'/%3E%3C/svg%3E");
    }

    .icon-close {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%23ffffff' viewBox='0 0 24 24'%3E%3Cpath d='M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z'/%3E%3C/svg%3E");
    }
    
    /* Responsive Design */
    @media (max-width: 1200px) {
      .main-wrapper {
        max-width: 98vw;
        padding: 24px 16px;
      }
      
      .section-card {
        padding: 32px 24px;
      }
      
      table th, table td {
        padding: 16px 12px;
      }
    }
    
    @media (max-width: 768px) {
      .main-wrapper {
        padding: 16px 12px;
      }
      
      .section-card {
        padding: 24px 16px;
        margin: 24px auto 0 auto;
      }
      
      h1 {
        font-size: 2rem;
        margin-bottom: 32px;
      }
      
      h2 {
        font-size: 1.5rem;
        margin-top: 32px;
      }
      
      table th, table td {
        padding: 12px 8px;
        font-size: 0.9rem;
      }
      
      button, .btn-logout {
        padding: 10px 16px;
        font-size: 0.9rem;
      }
      
      .btn-logout {
        float: none;
        display: block;
        width: 100%;
        margin-bottom: 16px;
      }
    }
    
    @media (max-width: 480px) {
      .main-wrapper {
        padding: 12px 8px;
      }
      
      .section-card {
        padding: 20px 12px;
      }
      
      h1 {
        font-size: 1.5rem;
      }
      
      h2 {
        font-size: 1.3rem;
      }
      
      table th, table td {
        padding: 8px 6px;
        font-size: 0.8rem;
      }
    }
  </style>
  <script>
  window.onload = function () {
    const token = localStorage.getItem('token');
    const brandId = localStorage.getItem('brandId');

    // 🛡 Проверка: есть ли токен и ID бренда
    if (!token || !brandId) {
      alert("🚫 Только для авторизованных брендов");
      location.href = '/brand-login.html';
      return;
    } else{ 
      loadCampaigns(); 
      loadScreens();
      loadBrandStats(); // Add statistics loading
      loadBrandInfo(); // Load brand name for welcome message
    }

  };
  </script>  
  
</head>
<body>
<!-- Floating Elements -->
<div class="floating-element"></div>
<div class="floating-element"></div>

<div class="main-wrapper">

<button onclick="logout()" class="btn-logout">Выйти из системы</button>
<script>
  function logout() {       // выход из бренда
    localStorage.clear();
    window.location.replace('/brand-login.html');
  }
</script>

<h1 id="welcomeTitle">Добро пожаловать в панель бренда</h1>

<!-- Statistics Section -->
<div class="section-card">
  <h2><span class="icon icon-stats"></span>Статистика</h2>
  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button onclick="loadBrandStats()" class="btn btn-success"><span class="icon icon-refresh"></span>Обновить</button>
    <button onclick="openBrandChart()" class="btn btn-main"><span class="icon icon-chart"></span>Подробная статистика</button>
  </div>
  <div id="brandStatsSummary"></div>
</div>

<div class="section-card">
  <h2>Ваши кампании</h2>
  <table id="campaignsTable">
    <thead>
      <tr><th>Название кампании</th><th>Период активности</th><th>Медиафайлы</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="section-card">
  <h2>Ваши экраны</h2>
  <table id="screensTable">
    <thead>
      <tr><th>ID экрана</th><th>Статус экрана</th><th>Кампания</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Brand Chart Modal -->
<div id="brandChartModal" class="modal" onclick="closeBrandChartModal()">
  <div class="modal-content" style="width: 95%; max-width: 1200px; margin: 2% auto; border-radius: 15px !important; overflow: hidden;" onclick="event.stopPropagation()">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">
      <h2 style="margin: 0; color: #c9b5ff; font-size: 24px;"><span class="icon icon-stats"></span>Детальная статистика бренда</h2>
      <button onclick="closeBrandChartModal()" class="btn btn-danger" style="margin: 0;"><span class="icon icon-close"></span>Закрыть</button>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 300px; gap: 30px; margin-bottom: 30px; min-height: 500px;">
      <!-- Chart Section -->
      <div style="background: #0f0e19; padding: 20px; border-radius: 10px; overflow: hidden;">
        <div style="margin-bottom: 20px;">
          <label style="font-weight: bold; margin-right: 10px; color: #c9b5ff;"><span class="icon icon-calendar"></span>Период:</label>
          <select id="chartPeriod" onchange="loadBrandChart()" style="color: #c9b5ff; padding: 8px 15px; border: 1px solid #c9b5ff; border-radius: 5px; background: #23203a;">
            <option value="7">Последние 7 дней</option>
            <option value="30">Последние 30 дней</option>
            <option value="90">Последние 3 месяца</option>
            <option value="365">Последний год</option>
          </select>
        </div>
        
        <div style="background: #0f0e19; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
          <canvas id="brandChart" width="400" height="400" style="max-width: 100%; height: auto;"></canvas>
        </div>
      </div>
      
      <!-- Stats Section -->
      <div id="brandChartDetails" style="background: #0f0e19; padding: 20px; border-radius: 10px; height: fit-content; overflow: hidden;"></div>
    </div>
  </div>
</div>

<script>
// Загрузка кампаний бренда через brandId /api/admin/brands/:brandId/campaigns
async function loadCampaigns() {
  const brandId = localStorage.getItem('brandId');
  const res = await fetch(`/api/brand/${brandId}/campaigns`, {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('token')
    }
  });

  const { campaigns } = await res.json();  
  const table = document.querySelector("#campaignsTable tbody");
  table.innerHTML = "";

  campaigns.forEach(c => {
    const startDate = c.startDate ? new Date(c.startDate).toLocaleDateString('ru-RU') : '-';
    const endDate = c.endDate ? new Date(c.endDate).toLocaleDateString('ru-RU') : '-';
    
    const row = document.createElement('tr');
    
    const nameCell = document.createElement('td');
    const nameStrong = document.createElement('strong');
    nameStrong.textContent = c.name;
    nameCell.appendChild(nameStrong);
    
    const dateCell = document.createElement('td');
    dateCell.textContent = `${startDate} — ${endDate}`;
    
    const videosCell = document.createElement('td');
    c.videos.forEach(v => {
      const link = document.createElement('a');
      link.href = v;
      link.target = '_blank';
      link.innerHTML = '<span class="icon icon-video"></span>';
      link.style.display = 'inline-block';
      link.style.marginRight = '8px';
      videosCell.appendChild(link);
    });
    
    row.appendChild(nameCell);
    row.appendChild(dateCell);
    row.appendChild(videosCell);
    
    table.appendChild(row);
  });
}


// === Экраны бренда
async function loadScreens() {
  const brandId = localStorage.getItem('brandId');
  const res = await fetch(`/api/brand/${brandId}/screens`, {
    headers: {
      'Authorization': 'Bearer ' + localStorage.getItem('token')
    }
  });

  const { screens } = await res.json();
  const table = document.querySelector("#screensTable tbody");
  table.innerHTML = "";

  screens.forEach(s => {
    const row = document.createElement('tr');
    
    // Screen ID column
    const screenIdCell = document.createElement('td');
    const screenIdStrong = document.createElement('strong');
    screenIdStrong.textContent = s.screenId;
    screenIdCell.appendChild(screenIdStrong);
    
    // Screen Status column (Online/Offline)
    const screenStatusCell = document.createElement('td');
    const statusBadge = document.createElement('span');
    const isOnline = s.isOnline !== false; // Default to true if not set
    statusBadge.style.cssText = `
      padding: 4px 12px; 
      border-radius: 12px; 
      font-size: 0.85rem; 
      font-weight: 500; 
      ${isOnline ? 
        'background: linear-gradient(135deg, #59FF70, #38f9d7); color: #ffffff;' : 
        'background: linear-gradient(135deg, #FF7A45, #a83279); color: #ffffff;'
      }
    `;
    statusBadge.textContent = isOnline ? '🟢 Включен' : '🔴 Выключен';
    screenStatusCell.appendChild(statusBadge);
    
    // Campaign column
    const campaignCell = document.createElement('td');
    if (s.currentCampaignId && s.campaignName) {
      const campaignSpan = document.createElement('span');
      campaignSpan.className = 'status-active';
      campaignSpan.textContent = s.campaignName;
      campaignCell.appendChild(campaignSpan);
    } else {
      const noAssignmentSpan = document.createElement('span');
      noAssignmentSpan.className = 'status-inactive';
      noAssignmentSpan.textContent = 'Не назначена';
      campaignCell.appendChild(noAssignmentSpan);
    }
    
    row.appendChild(screenIdCell);
    row.appendChild(screenStatusCell);
    row.appendChild(campaignCell);
    
    table.appendChild(row);
  });
}

// ===== BRAND INFO FUNCTIONS =====
async function loadBrandInfo() {
  try {
    const brandId = localStorage.getItem('brandId');
    const token = localStorage.getItem('token');
    
    if (!brandId || !token) {
      console.error('Missing brandId or token');
      return;
    }

    const res = await fetch(`/api/brand/${brandId}/info`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    if (!res.ok) {
      console.error('Failed to load brand info:', res.status);
      return;
    }

    const data = await res.json();
    updateWelcomeMessage(data.name);
  } catch (error) {
    console.error('Error loading brand info:', error);
  }
}

function updateWelcomeMessage(brandName) {
  const titleElement = document.getElementById('welcomeTitle');
  if (titleElement && brandName) {
    // Escape HTML to prevent XSS
    const escapedBrandName = brandName.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    titleElement.innerHTML = `Добро пожаловать в панель, {<span style="background: linear-gradient(135deg, #3b82f6, #84cc16, #f97316); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">${escapedBrandName}</span>}!`;
  }
}

// ===== BRAND STATISTICS FUNCTIONS =====
let brandChart = null;

async function loadBrandStats() {
  try {
    const brandId = localStorage.getItem('brandId');
    const token = localStorage.getItem('token');
    
    if (!brandId || !token) {
      console.error('Missing brandId or token');
      return;
    }

    const res = await fetch(`/api/brand/${brandId}/stats`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    if (!res.ok) {
      console.error('Failed to load stats:', res.status);
      return;
    }

    const data = await res.json();
    displayBrandStats(data);
  } catch (error) {
    console.error('Error loading brand stats:', error);
  }
}

function displayBrandStats(data) {
  const div = document.getElementById('brandStatsSummary');
  if (!div) return;

  let html = '';
  
  // Overall stats
  html += `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
      <div style="background: rgba(24, 160, 251, 0.1); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(24, 160, 251, 0.3);">
        <h3 style="margin: 0 0 10px 0; color: #18A0FB;"><span class="icon icon-eye"></span>Показы</h3>
        <div style="font-size: 24px; font-weight: bold; color: #ffffff;">${data.total?.impressions || 0}</div>
      </div>
      <div style="background: rgba(89, 255, 112, 0.1); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(89, 255, 112, 0.3);">
        <h3 style="margin: 0 0 10px 0; color: #59FF70;"><span class="icon icon-click"></span>Клики</h3>
        <div style="font-size: 24px; font-weight: bold; color: #ffffff;">${data.total?.clicks || 0}</div>
      </div>
      <div style="background: rgba(255, 122, 69, 0.1); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(255, 122, 69, 0.3);">
        <h3 style="margin: 0 0 10px 0; color: #FF7A45;"><span class="icon icon-percentage"></span>CTR</h3>
        <div style="font-size: 24px; font-weight: bold; color: #ffffff;">${data.ctr || '0.00'}%</div>
      </div>
    </div>
  `;

  // Detailed stats by screens
  if (data.detailedByScreen && data.detailedByScreen.length > 0) {
    html += '<h4 style="margin-top: 30px; margin-bottom: 15px; color: #dee2e6;"><span class="icon icon-mobile"></span>Статистика по экранам:</h4>';
    data.detailedByScreen.forEach(screen => {
      html += `
        <div style="margin: 10px 0; padding: 15px; background: rgba(33, 37, 41, 0.6); border: 1px solid rgba(52, 58, 64, 0.5); border-radius: 8px;">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong style="color: #18A0FB;">Экран: ${screen.screenId}</strong>
              ${screen.campaignName ? `<br><small style="color: #6c757d;">Кампания: ${screen.campaignName}</small>` : ''}
            </div>
            <div style="text-align: right;">
              <div style="color: #59FF70; font-weight: 600;">${screen.impressions} показов</div>
              <div style="color: #FF7A45; font-weight: 600;">${screen.clicks} кликов</div>
            </div>
          </div>
        </div>
      `;
    });
  } else {
    html += '<p style="color: #6c757d; font-style: italic; margin-top: 20px;">Нет данных для отображения</p>';
  }

  div.innerHTML = html;
}

async function openBrandChart() {
  const brandId = localStorage.getItem('brandId');
  if (!brandId) return;
  
  document.getElementById('brandChartModal').style.display = 'block';
  await loadBrandChart();
}

async function loadBrandChart() {
  try {
    const brandId = localStorage.getItem('brandId');
    const token = localStorage.getItem('token');
    const period = document.getElementById('chartPeriod').value;
    
    if (!brandId || !token) return;

    const res = await fetch(`/api/brand/${brandId}/stats/chart?days=${period}`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });

    if (!res.ok) {
      console.error('Failed to load chart data:', res.status);
      return;
    }

    const data = await res.json();
    
    // Destroy existing chart
    if (brandChart) {
      brandChart.destroy();
    }
    
    // Create new chart
    const ctx = document.getElementById('brandChart').getContext('2d');
    brandChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.labels,
        datasets: [
          {
            label: 'Показы',
            data: data.impressions,
            borderColor: 'rgb(24, 160, 251)',
            backgroundColor: 'rgba(24, 160, 251, 0.2)',
            tension: 0.1
          },
          {
            label: 'Клики',
            data: data.clicks,
            borderColor: 'rgb(89, 255, 112)',
            backgroundColor: 'rgba(89, 255, 112, 0.2)',
            tension: 0.1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          title: {
            display: true,
            text: 'Статистика по дням',
            color: '#c9b5ff'
          },
          legend: {
            labels: {
              color: '#c9b5ff'
            }
          }
        },
        scales: {
          x: {
            ticks: {
              color: '#c9b5ff'
            },
            grid: {
              color: 'rgba(201, 181, 255, 0.1)'
            }
          },
          y: {
            beginAtZero: true,
            ticks: {
              color: '#c9b5ff'
            },
            grid: {
              color: 'rgba(201, 181, 255, 0.1)'
            }
          }
        }
      }
    });
    
    // Update details section
    updateChartDetails(data);
    
  } catch (error) {
    console.error('Chart error:', error);
    alert('Ошибка загрузки графика: ' + error.message);
  }
}

function updateChartDetails(data) {
  const detailsDiv = document.getElementById('brandChartDetails');
  if (!detailsDiv) return;
  
  let detailsHtml = '<h3 style="margin: 0 0 20px 0; color: #c9b5ff; border-bottom: 2px solid #18A0FB; padding-bottom: 10px;"><span class="icon icon-chart"></span>Основные показатели</h3>';
  
  if (data.hasAllTimeData) {
    detailsHtml += '<div style="background: #0f0e19; border: 1px solid #ffeaa7; border-radius: 5px; padding: 10px; margin-bottom: 20px; color: #c9b5ff;">⚠️ Показаны данные за все время (нет данных за выбранный период)</div>';
  }
  
  detailsHtml += `
    <div style="background: #0f0e19; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">Показы:</span>
        <span style="font-size: 18px; font-weight: bold; color: #18A0FB;">${data.totalImpressions || 0}</span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">Клики:</span>
        <span style="font-size: 18px; font-weight: bold; color: #59FF70;">${data.totalClicks || 0}</span>
      </div>
      <div style="display: flex; justify-content: space-between; border-top: 1px solid #333; padding-top: 10px;">
        <span style="font-weight: bold; color: #c9b5ff;">CTR:</span>
        <span style="font-size: 18px; font-weight: bold; color: #ffc107;">${data.ctr || '0.00'}%</span>
      </div>
    </div>
  `;
  
  if (data.topScreens && data.topScreens.length > 0) {
    detailsHtml += '<h4 style="margin: 20px 0 15px 0; color: #c9b5ff;"><span class="icon icon-mobile"></span>Топ экранов</h4>';
    detailsHtml += '<div style="background: #0f0e19; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
    data.topScreens.forEach((screen, index) => {
      detailsHtml += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; ${index > 0 ? 'border-top: 1px solid #333;' : ''}">
          <div style="font-weight: 500; color: #c9b5ff; max-width: 60%; word-break: break-word;">${screen.screenName || screen.screenId || 'Неизвестный экран'}</div>
          <div style="text-align: right; min-width: 120px;">
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${screen.impressions} показов</span>
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${screen.clicks} кликов</span>
          </div>
        </div>
      `;
    });
    detailsHtml += '</div>';
  }
  
  if (data.topCampaigns && data.topCampaigns.length > 0) {
    detailsHtml += '<h4 style="margin: 20px 0 15px 0; color: #c9b5ff;"><span class="icon icon-target"></span>Топ кампаний</h4>';
    detailsHtml += '<div style="background: #0f0e19; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
    data.topCampaigns.forEach((campaign, index) => {
      detailsHtml += `
        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px 0; ${index > 0 ? 'border-top: 1px solid #333;' : ''}">
          <div style="font-weight: 500; color: #c9b5ff; max-width: 60%; word-break: break-word;">${campaign.name}</div>
          <div style="text-align: right; min-width: 120px;">
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${campaign.impressions} показов</span>
            <span style="display: block; color: #c9b5ff; font-size: 1.05em; font-weight: 400;">${campaign.clicks} кликов</span>
          </div>
        </div>
      `;
    });
    detailsHtml += '</div>';
  }
  
  detailsDiv.innerHTML = detailsHtml;
}

function closeBrandChartModal() {
  document.getElementById('brandChartModal').style.display = 'none';
  if (brandChart) {
    brandChart.destroy();
    brandChart = null;
  }
}

</script>

</div>
</body>
</html>

