<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'none';">
  <title>Реклама в такси</title>
  <!-- Font Preloading for Performance -->
  <link rel="preload" href="/fonts/SF-Pro-Display-Regular.otf" as="font" type="font/otf" crossorigin>
  <link rel="preload" href="/fonts/SF-Pro-Display-Medium.otf" as="font" type="font/otf" crossorigin>
  <link rel="preload" href="/fonts/SF-Pro-Display-Bold.otf" as="font" type="font/otf" crossorigin>
  <style>
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Regular.otf') format('opentype');
      font-weight: 400;
      font-style: normal;
      font-display: block;
    }
    
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Medium.otf') format('opentype');
      font-weight: 500;
      font-style: normal;
      font-display: block;
    }
    
    @font-face {
      font-family: 'SF Pro Display';
      src: url('/fonts/SF-Pro-Display-Bold.otf') format('opentype');
      font-weight: 700;
      font-style: normal;
      font-display: block;
    }
    
    * {
      box-sizing: border-box;
    }
    
    html, body {
      font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #050505 0%, #0a0a0a 25%, #0d1117 50%, #161b22 75%, #1a1a2e 100%);
      height: 100%;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* Background Effects */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: 
        radial-gradient(circle at 25% 25%, rgba(24, 160, 251, 0.05) 0%, transparent 50%),
        radial-gradient(circle at 75% 75%, rgba(89, 255, 112, 0.05) 0%, transparent 50%);
      background-size: 100px 100px, 150px 150px;
      opacity: 0.3;
      z-index: -1;
    }
    
    video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
      position: relative;
      z-index: 1;
    }
    
    /* Loading Screen */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #050505 0%, #0a0a0a 25%, #0d1117 50%, #161b22 75%, #1a1a2e 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      transition: opacity 0.5s ease;
    }
    
    .loading-screen.hidden {
      opacity: 0;
      pointer-events: none;
    }
    
    .loading-logo {
      width: 120px;
      height: 120px;
      margin-bottom: 32px;
      filter: drop-shadow(0 4px 12px rgba(24, 160, 251, 0.3));
      animation: pulse 2s ease-in-out infinite;
    }
    
    .loading-text {
      color: #ffffff;
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 24px;
      background: linear-gradient(135deg, #18A0FB, #59FF70);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(24, 160, 251, 0.3);
      border-top: 3px solid #18A0FB;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    .error-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #050505 0%, #0a0a0a 25%, #0d1117 50%, #161b22 75%, #1a1a2e 100%);
      display: none;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
    }
    
    .error-screen.show {
      display: flex;
    }
    
    .error-icon {
      width: 80px;
      height: 80px;
      margin-bottom: 24px;
      color: #FF7A45;
      filter: drop-shadow(0 4px 12px rgba(255, 122, 69, 0.3));
    }
    
    .error-text {
      color: #ffffff;
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      max-width: 400px;
      margin-bottom: 16px;
    }
    
    .error-subtext {
      color: #6c757d;
      font-size: 0.9rem;
      text-align: center;
    }
    
    /* Status Indicator */
    .status-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(33, 37, 41, 0.8);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(52, 58, 64, 0.5);
      border-radius: 12px;
      padding: 12px 16px;
      color: #ffffff;
      font-size: 0.8rem;
      font-weight: 500;
      z-index: 5;
      opacity: 0.8;
      transition: opacity 0.3s ease;
    }
    
    .status-indicator:hover {
      opacity: 1;
    }
    
    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #59FF70;
      margin-right: 8px;
      animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Floating Elements */
    .floating-element {
      position: fixed;
      border-radius: 8px;
      opacity: 0.1;
      animation: float 6s ease-in-out infinite;
      z-index: 0;
    }
    
    .floating-element:nth-child(1) {
      top: 20%;
      left: 10%;
      width: 60px;
      height: 40px;
      background: linear-gradient(135deg, rgba(24, 160, 251, 0.2), rgba(89, 255, 112, 0.2));
      border: 1px solid rgba(24, 160, 251, 0.3);
      animation-delay: 0s;
    }
    
    .floating-element:nth-child(2) {
      top: 60%;
      right: 15%;
      width: 40px;
      height: 30px;
      background: linear-gradient(135deg, rgba(89, 255, 112, 0.2), rgba(255, 122, 69, 0.2));
      border: 1px solid rgba(89, 255, 112, 0.3);
      animation-delay: 2s;
    }
    
    @keyframes float {
      0%, 100% { transform: translateY(0px) rotate(0deg); }
      50% { transform: translateY(-20px) rotate(5deg); }
    }

    /* Touch Blocker Overlay */
    .touch-blocker {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 9999;
      background: transparent;
      touch-action: none;
      pointer-events: auto;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
    }

    .touch-blocker.disabled {
      pointer-events: none;
    }

    /* Prevent text selection and context menus */
    * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }

    /* Hide scrollbars */
    ::-webkit-scrollbar {
      display: none;
    }

    html {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }

    /* Kiosk mode styles */
    body.kiosk-mode {
      overflow: hidden !important;
      position: fixed !important;
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>
<body>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
  <img src="/images/Lunqo-white.59026c78beb9c7f20c86.png" alt="Lunqo Logo" class="loading-logo">
  <div class="loading-text">Загрузка рекламы...</div>
  <div class="loading-spinner"></div>
</div>

<!-- Error Screen -->
<div class="error-screen" id="errorScreen">
  <div class="error-icon">⚠️</div>
  <div class="error-text">Нет доступной рекламы</div>
  <div class="error-subtext">Попробуйте позже</div>
</div>

<!-- Status Indicator -->
<div class="status-indicator" id="statusIndicator">
  <span class="status-dot"></span>
  <span id="statusText">Подключение...</span>
</div>

<!-- Touch Blocker -->
<div class="touch-blocker" id="touchBlocker"></div>

<!-- Floating Elements -->
<div class="floating-element"></div>
<div class="floating-element"></div>

<video id="videoPlayer" autoplay muted playsinline></video>

<script>
  // ===== ENVIRONMENT DETECTION =====
  // Browser-compatible environment detection
  const isProduction = window.location.hostname !== 'localhost' && 
                      window.location.hostname !== '127.0.0.1' && 
                      !window.location.hostname.includes('dev') &&
                      !window.location.hostname.includes('test');

  const screenId = new URLSearchParams(window.location.search).get('screenId') || 'TEST';
  const videoEl = document.getElementById('videoPlayer');
  const loadingScreen = document.getElementById('loadingScreen');
  const errorScreen = document.getElementById('errorScreen');
  const statusIndicator = document.getElementById('statusIndicator');
  const statusText = document.getElementById('statusText');
  const touchBlocker = document.getElementById('touchBlocker');
  
  let playlist = [];
  let index = 0;
  let campaignId = '';
  let brandId = '';
  let isKioskMode = true; // Enable kiosk mode by default
  let fullscreenCheckInterval;

  // ===== KIOSK MODE & SECURITY FUNCTIONS =====
  
  // Force fullscreen mode
  function enterFullscreen() {
    const element = document.documentElement;
    
    if (element.requestFullscreen) {
      element.requestFullscreen().catch(err => {
        if (!isProduction) console.log('Fullscreen request failed:', err);
      });
    } else if (element.webkitRequestFullscreen) {
      element.webkitRequestFullscreen();
    } else if (element.mozRequestFullScreen) {
      element.mozRequestFullScreen();
    } else if (element.msRequestFullscreen) {
      element.msRequestFullscreen();
    }
  }

  // Check if we're in fullscreen and force it if not
  function checkFullscreen() {
    const isFullscreen = !!(document.fullscreenElement || 
                           document.webkitFullscreenElement || 
                           document.mozFullScreenElement || 
                           document.msFullscreenElement);
    
    if (!isFullscreen && isKioskMode) {
      if (!isProduction) console.log('🔒 Forcing fullscreen mode');
      enterFullscreen();
    }
  }

  // Initialize kiosk mode
  function initKioskMode() {
    if (!isKioskMode) return;

    document.body.classList.add('kiosk-mode');
    
    // Force fullscreen on load
    setTimeout(() => {
      enterFullscreen();
    }, 1000);

    // Check fullscreen every 2 seconds
    fullscreenCheckInterval = setInterval(checkFullscreen, 2000);

    // Block common keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      const blockedKeys = [
        'F11', 'F12', 'F1', 'F2', 'F3', 'F4', 'F5',
        'Tab', 'Alt', 'Meta', 'Control'
      ];
      
      // Block Ctrl+key combinations
      if (e.ctrlKey || e.metaKey) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Block Alt+key combinations
      if (e.altKey) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Block specific keys
      if (blockedKeys.includes(e.key) || blockedKeys.includes(e.code)) {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
      
      // Block Escape key (exits fullscreen)
      if (e.key === 'Escape') {
        e.preventDefault();
        e.stopPropagation();
        return false;
      }
    }, true);

    // Block right-click context menu
    document.addEventListener('contextmenu', (e) => {
      e.preventDefault();
      return false;
    });

    // Block text selection
    document.addEventListener('selectstart', (e) => {
      e.preventDefault();
      return false;
    });

    // Block drag and drop
    document.addEventListener('dragstart', (e) => {
      e.preventDefault();
      return false;
    });
  }

  // Initialize touch blocker
  function initTouchBlocker() {
    if (!touchBlocker) return;

    // Block all touch events
    const blockEvents = ['touchstart', 'touchmove', 'touchend', 'touchcancel'];
    
    blockEvents.forEach(eventType => {
      touchBlocker.addEventListener(eventType, (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (!isProduction) {
          console.log('🚫 Touch blocked:', eventType);
        }
        
        return false;
      }, { passive: false, capture: true });
    });

    // Also block mouse events for desktop testing
    const mouseEvents = ['mousedown', 'mouseup', 'mousemove', 'click', 'dblclick'];
    
    mouseEvents.forEach(eventType => {
      touchBlocker.addEventListener(eventType, (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        if (!isProduction) {
          console.log('🚫 Mouse blocked:', eventType);
        }
        
        return false;
      }, { passive: false, capture: true });
    });

    if (!isProduction) {
      console.log('🔒 Touch blocker initialized');
    }
  }

  // Handle fullscreen change events
  document.addEventListener('fullscreenchange', () => {
    if (!isProduction) {
      const isFullscreen = !!document.fullscreenElement;
      console.log('📺 Fullscreen changed:', isFullscreen);
    }
  });

  document.addEventListener('webkitfullscreenchange', () => {
    if (!isProduction) {
      const isFullscreen = !!document.webkitFullscreenElement;
      console.log('📺 Webkit fullscreen changed:', isFullscreen);
    }
  });

  // Handle visibility change (detect when user switches tabs/apps)
  document.addEventListener('visibilitychange', () => {
    if (document.hidden && isKioskMode) {
      if (!isProduction) console.log('🔒 Tab hidden, attempting to regain focus');
      
      // Try to bring back focus
      setTimeout(() => {
        window.focus();
        enterFullscreen();
      }, 100);
    }
  });

  // Handle window focus events
  window.addEventListener('blur', () => {
    if (isKioskMode) {
      if (!isProduction) console.log('🔒 Window lost focus, regaining...');
      setTimeout(() => {
        window.focus();
      }, 100);
    }
  });

  // Update status indicator
  function updateStatus(text) {
    statusText.textContent = text;
    if (!isProduction) {
      console.log('📊 Status:', text);
    }
  }

  // Show error screen
  function showError() {
    loadingScreen.classList.add('hidden');
    errorScreen.classList.add('show');
    updateStatus('Ошибка загрузки');
  }

  // Hide loading screen
  function hideLoading() {
    loadingScreen.classList.add('hidden');
    updateStatus('Воспроизведение');
  }

  // Получаем плейлист с сервера
  async function fetchPlaylist() {
    try {
      updateStatus('Загрузка плейлиста...');
      const res = await fetch(`/api/screens/${screenId}/playlist`);
      const data = await res.json();

      if (data && data.videos && data.videos.length > 0) {
        playlist = data.videos;
        campaignId = data.campaignId || '';
        brandId = data.brandId || '';
        index = 0;
        updateStatus('Плейлист загружен');
        playVideo();
      } else {
        if (!isProduction) {
          console.log("Нет видео в плейлисте");
        }
        showError();
      }
    } catch (err) {
      console.error('Ошибка получения плейлиста:', err);
      showError();
    }
  }

  // Воспроизводим видео
  function playVideo() {
    if (playlist.length === 0) return;

    videoEl.src = playlist[index];
    videoEl.load();
    
    videoEl.onloadeddata = () => {
      hideLoading();
      videoEl.play();
      updateStatus(`Видео ${index + 1}/${playlist.length}`);
    };

    if (!isProduction) {
      console.log(`▶️ Воспроизведение видео: ${playlist[index]}`);
    }

    index = (index + 1) % playlist.length;
  }

  videoEl.addEventListener('ended', playVideo);

  // Отправка статистики каждые 30 секунд
  setInterval(() => {
    if (!playlist.length || !campaignId || !brandId) {
      if (!isProduction) {
        console.log('❌ Не могу отправить статистику: отсутствуют данные', { playlist: playlist.length, campaignId, brandId });
      }
      return;
    }

    if (!isProduction) {
      console.log('📊 Отправляю статистику:', { screenId, campaignId, brandId, event: 'impression' });
    }

    fetch('/api/stats', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        screenId,
        campaignId,
        brandId,
        event: 'impression'
      })
    }).then(res => {
      if (!res.ok) {
        return res.text().then(text => {
          throw new Error(`HTTP ${res.status}: ${text}`);
        });
      }
      return res.json();
    }).then(data => {
      if (!isProduction) {
        console.log('✅ Импрессия отправлена:', data);
      }
    }).catch(err => {
      console.error('❌ Ошибка отправки статистики:', err);
    });
  }, 30000);

  // ===== ADMIN UNLOCK SEQUENCE =====
  let unlockSequence = [];
  const unlockCode = ['KeyK', 'KeyI', 'KeyO', 'KeyS', 'KeyK']; // K-I-O-S-K sequence
  
  function handleUnlockSequence(e) {
    if (!isKioskMode) return;
    
    unlockSequence.push(e.code);
    
    // Keep only last 5 keys
    if (unlockSequence.length > unlockCode.length) {
      unlockSequence.shift();
    }
    
    // Check if sequence matches
    if (unlockSequence.length === unlockCode.length && 
        unlockSequence.every((key, index) => key === unlockCode[index])) {
      
      disableKioskMode();
      unlockSequence = [];
      
      if (!isProduction) {
        console.log('🔓 Kiosk mode disabled by admin sequence');
      }
    }
  }
  
  // Disable kiosk mode (for admin access)
  function disableKioskMode() {
    isKioskMode = false;
    
    if (fullscreenCheckInterval) {
      clearInterval(fullscreenCheckInterval);
    }
    
    document.body.classList.remove('kiosk-mode');
    touchBlocker.classList.add('disabled');
    
    // Exit fullscreen
    if (document.exitFullscreen) {
      document.exitFullscreen();
    } else if (document.webkitExitFullscreen) {
      document.webkitExitFullscreen();
    } else if (document.mozCancelFullScreen) {
      document.mozCancelFullScreen();
    } else if (document.msExitFullscreen) {
      document.msExitFullscreen();
    }
    
    updateStatus('Kiosk mode отключен');
    
    // Show unlock notification
    setTimeout(() => {
      alert('🔓 Kiosk mode disabled.\nRefresh page to re-enable.');
    }, 500);
  }
  
  // Add unlock sequence listener
  document.addEventListener('keydown', handleUnlockSequence);

  // ===== ADDITIONAL SECURITY MEASURES =====
  
  // Prevent iframe embedding at runtime
  if (window.top !== window.self) {
    window.top.location = window.self.location;
  }
  
  // Block common developer tools shortcuts
  document.addEventListener('keydown', (e) => {
    // Block F12 (DevTools)
    if (e.keyCode === 123) {
      e.preventDefault();
      return false;
    }
    
    // Block Ctrl+Shift+I (DevTools)
    if (e.ctrlKey && e.shiftKey && e.keyCode === 73) {
      e.preventDefault();
      return false;
    }
    
    // Block Ctrl+Shift+J (Console)
    if (e.ctrlKey && e.shiftKey && e.keyCode === 74) {
      e.preventDefault();
      return false;
    }
    
    // Block Ctrl+U (View Source)
    if (e.ctrlKey && e.keyCode === 85) {
      e.preventDefault();
      return false;
    }
    
    // Block Ctrl+Shift+C (Element Inspector)
    if (e.ctrlKey && e.shiftKey && e.keyCode === 67) {
      e.preventDefault();
      return false;
    }
  });
  
  // Detect developer tools (basic detection)
  setInterval(() => {
    if (isKioskMode) {
      const threshold = 160;
      if (window.outerHeight - window.innerHeight > threshold || 
          window.outerWidth - window.innerWidth > threshold) {
        if (!isProduction) {
          console.log('🔒 Potential developer tools detected');
        }
        // Could add additional actions here like reloading or alerting
      }
    }
  }, 5000);

  // Prevent page zoom
  document.addEventListener('wheel', (e) => {
    if (e.ctrlKey) {
      e.preventDefault();
      return false;
    }
  }, { passive: false });

  // Block pinch-to-zoom on mobile
  document.addEventListener('touchmove', (e) => {
    if (e.touches.length > 1) {
      e.preventDefault();
    }
  }, { passive: false });

  // ===== INITIALIZATION =====
  
  // Initialize security features
  initKioskMode();
  initTouchBlocker();
  
  // Initialize playlist
  fetchPlaylist();
</script>

</body>
</html>