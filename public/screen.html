<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–†–µ–∫–ª–∞–º–∞ –≤ —Ç–∞–∫—Å–∏</title>
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="icon" type="image/png" href="/favicon.png">
  <link rel="shortcut icon" href="/favicon.ico">
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      height: 100%;
      overflow: hidden;
    }
    video {
      width: 100vw;
      height: 100vh;
      object-fit: cover;
    }
  </style>
</head>
<body>

<video id="videoPlayer" autoplay muted playsinline></video>

<script>
  const screenId = new URLSearchParams(window.location.search).get('screenId') || 'TEST';
  const videoEl = document.getElementById('videoPlayer');
  let playlist = [];
  let index = 0;
  let campaignId = '';
  let brandId = '';

  // –ü–æ–ª—É—á–∞–µ–º –ø–ª–µ–π–ª–∏—Å—Ç —Å —Å–µ—Ä–≤–µ—Ä–∞
  async function fetchPlaylist() {
    try {
      const res = await fetch(`https://lunqo.app/api/screens/${screenId}/playlist`);
      const data = await res.json();

      if (data && data.videos && data.videos.length > 0) {
        playlist = data.videos;
        campaignId = data.campaignId || '';
        brandId = data.brandId || '';
        index = 0;
        playVideo();
      } else {
        console.log("–ù–µ—Ç –≤–∏–¥–µ–æ –≤ –ø–ª–µ–π–ª–∏—Å—Ç–µ");
      }
    } catch (err) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø–ª–µ–π–ª–∏—Å—Ç–∞:', err);
    }
  }

  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º –≤–∏–¥–µ–æ
  function playVideo() {
    if (playlist.length === 0) return;

    videoEl.src = playlist[index];
    videoEl.load();
    videoEl.play();

    console.log(`‚ñ∂Ô∏è –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –≤–∏–¥–µ–æ: ${playlist[index]}`);

    index = (index + 1) % playlist.length;
  }

  videoEl.addEventListener('ended', playVideo);

  // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
  setInterval(() => {
    if (!playlist.length || !campaignId || !brandId) {
      console.log('‚ùå –ù–µ –º–æ–≥—É –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É: –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ', { playlist: playlist.length, campaignId, brandId });
      return;
    }

    console.log('üìä –û—Ç–ø—Ä–∞–≤–ª—è—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:', { screenId, campaignId, brandId, event: 'impression' });

    fetch(`https://lunqo.app/api/stats`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        screenId,
        campaignId,
        brandId,
        event: 'impression'
      })
    }).then(res => {
      if (!res.ok) {
        return res.text().then(text => {
          throw new Error(`HTTP ${res.status}: ${text}`);
        });
      }
      return res.json();
    }).then(data => {
      console.log('‚úÖ –ò–º–ø—Ä–µ—Å—Å–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞:', data);
    }).catch(err => {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', err);
    });
  }, 30000);

  fetchPlaylist();
</script>

</body>
</html>